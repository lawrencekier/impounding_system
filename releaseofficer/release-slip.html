<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Release Slip - LTO VIS</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      :root {
        --primary: #2563eb;
        --text-main: #1e293b;
        --text-muted: #64748b;
        --border: #e2e8f0;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Inter", "Segoe UI", Roboto, sans-serif;
      }

      body {
        background-color: #f1f5f9;
        padding: 40px;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
      }

      /* Controls (Hidden when printing) */
      .controls {
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
      }
      .btn {
        padding: 10px 20px;
        border-radius: 8px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        transition: 0.2s;
      }
      .btn-primary {
        background: var(--primary);
        color: white;
        box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
      }
      .btn-primary:hover {
        background: #1e40af;
      }
      .btn-outline {
        background: white;
        border: 1px solid var(--border);
        color: var(--text-muted);
      }
      .btn-outline:hover {
        background: #f8fafc;
        color: var(--text-main);
      }

      /* Slip Container */
      .release-slip {
        background: white;
        width: 100%;
        max-width: 800px;
        padding: 50px;
        border-radius: 12px; /* Smooth corners for screen */
        box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--border);
        position: relative;
        overflow: hidden;
      }

      /* Watermark */
      .watermark {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(-45deg);
        font-size: 80px;
        font-weight: 900;
        color: rgba(37, 99, 235, 0.04);
        pointer-events: none;
        white-space: nowrap;
        border: 4px solid rgba(37, 99, 235, 0.04);
        padding: 20px 40px;
        border-radius: 20px;
        text-transform: uppercase;
      }

      /* Header */
      .header {
        text-align: center;
        margin-bottom: 40px;
        border-bottom: 3px solid var(--primary);
        padding-bottom: 20px;
      }
      .logo-area {
        margin-bottom: 15px;
      }
      .logo-area svg {
        width: 60px;
        height: 60px;
      }
      .header h1 {
        font-size: 24px;
        font-weight: 800;
        color: var(--text-main);
        margin-bottom: 5px;
        letter-spacing: -0.5px;
      }
      .header p {
        font-size: 13px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
      }
      .slip-id {
        margin-top: 15px;
        font-family: monospace;
        background: #f1f5f9;
        padding: 5px 15px;
        border-radius: 20px;
        display: inline-block;
        font-weight: 700;
        font-size: 14px;
        color: var(--text-main);
      }

      /* Content Grid */
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 40px;
        margin-bottom: 30px;
      }

      .section {
        margin-bottom: 30px;
      }
      .section-title {
        font-size: 14px;
        font-weight: 700;
        color: var(--primary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid var(--border);
        padding-bottom: 8px;
        margin-bottom: 15px;
      }

      .row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        font-size: 14px;
      }
      .label {
        color: var(--text-muted);
        font-weight: 500;
      }
      .value {
        color: var(--text-main);
        font-weight: 600;
        text-align: right;
      }

      /* Footer & Signatures */
      .signatures {
        display: flex;
        justify-content: space-between;
        margin-top: 60px;
        padding-top: 20px;
      }
      .sig-box {
        width: 45%;
        text-align: center;
      }
      .sig-line {
        border-top: 1px solid #94a3b8;
        margin-bottom: 10px;
      }
      .sig-role {
        font-size: 12px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .sig-name {
        font-weight: 700;
        color: var(--text-main);
        font-size: 15px;
        margin-bottom: 2px;
      }

      .footer {
        text-align: center;
        margin-top: 40px;
        padding-top: 20px;
        border-top: 1px dashed var(--border);
        font-size: 12px;
        color: var(--text-muted);
        line-height: 1.5;
      }

      /* Loading State */
      .loading-state {
        text-align: center;
        padding: 50px;
        font-size: 16px;
        color: var(--text-muted);
      }

      /* Print Specifics */
      @media print {
        body {
          background: white;
          padding: 0;
        }
        .controls {
          display: none;
        }
        .release-slip {
          box-shadow: none;
          border: none;
          padding: 0;
          width: 100%;
          max-width: 100%;
        }
        .section-title {
          border-bottom-color: #000;
          color: #000;
        }
        .header {
          border-bottom-color: #000;
        }
        .slip-id {
          border: 1px solid #ccc;
          background: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="controls">
      <button class="btn btn-outline" onclick="window.close()">
        <i class="fas fa-times"></i> Close
      </button>
      <button class="btn btn-primary" onclick="window.print()">
        <i class="fas fa-print"></i> Print Slip
      </button>
    </div>

    <div class="release-slip" id="slipContent">
      <div class="loading-state">
        <i class="fas fa-spinner fa-spin"></i> Generating Release Slip...
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
      import {
        getFirestore,
        doc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyByzd88bcUAq0VdP0w6oB8W_b2AUgoIzXc",
        authDomain: "vehicle-impound.firebaseapp.com",
        projectId: "vehicle-impound",
        storageBucket: "vehicle-impound.appspot.com",
        messagingSenderId: "69239563292",
        appId: "1:69239563292:web:281912e8a38301c0feabd9",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      // Get ID from URL
      const urlParams = new URLSearchParams(window.location.search);
      const releaseId = urlParams.get("id");

      async function loadReleaseData() {
        if (!releaseId) {
          document.getElementById("slipContent").innerHTML =
            '<div style="text-align:center; color:red;">No Release ID Provided.</div>';
          return;
        }

        try {
          // 1. Fetch Release Record (Assuming passed ID is vehicleId based on flow, or actual releaseId)
          // If the previous page passes vehicleId, we might need to query.
          // BUT better flow: Release modal creates a record, gets its ID, and passes it here.
          // For simplicity/robustness, let's assume we pass the VEHICLE ID and fetch the latest release.
          // OR simpler: pass data via localStorage if purely client-side generation.
          // Let's stick to reading from DB for security/integrity.

          // NOTE: Since the previous code creates a release doc, getting THAT ID would be best.
          // Assuming `id` param is the VEHICLE ID for now as per common flow:

          // Fetch Vehicle Data
          const vDoc = await getDoc(doc(db, "impoundedVehicles", releaseId));
          if (!vDoc.exists()) throw new Error("Vehicle not found");
          const vData = vDoc.data();

          // Fetch Payment Data (Using vehicleId logic)
          // Note: In a real app, you'd query for the specific payment doc.
          // Here we assume standard fields on vehicle data if updated, or just display basic info.

          const now = new Date();

          renderSlip({
            id: "REL-" + releaseId.substring(0, 6).toUpperCase(),
            date: now.toLocaleDateString(),
            time: now.toLocaleTimeString(),

            plate: vData.plateNumber,
            type: vData.vehicleType,
            model: vData.vehicleModel || "N/A",
            color: vData.vehicleColor || "N/A",
            ref: releaseId.toUpperCase(),

            owner: vData.ownerName,
            contact: vData.ownerContact,
            address: vData.ownerAddress || "N/A",

            violation: vData.violationCode || "Traffic Violation",
            impoundDate: vData.impoundDate
              ? new Date(vData.impoundDate).toLocaleDateString()
              : "N/A",

            // Since it's a release slip, we assume it's fully paid
            status: "RELEASED / PAID",
          });
        } catch (e) {
          console.error(e);
          document.getElementById(
            "slipContent"
          ).innerHTML = `<div style="text-align:center; color:red;">Error: ${e.message}</div>`;
        }
      }

      function renderSlip(data) {
        const html = `
                <div class="watermark">OFFICIAL RELEASE</div>
                
                <div class="header">
                    <div class="logo-area">
                         <svg viewBox="0 0 512 512" fill="#2563eb">
                            <path d="M112,112c0-26.5,21.5-48,48-48h76.3c15.2-22,40.7-36.5,69.7-36.5s54.5,14.5,69.7,36.5H416c26.5,0,48,21.5,48,48v64H112V112z M306,83.5c-11.2,0-20.7,7.8-23.2,18.5h46.4C326.7,91.3,317.2,83.5,306,83.5z" />
                            <path d="M47.5,192C21.3,192,0,213.3,0,239.5v161C0,426.7,21.3,448,47.5,448h17.1c11,27.1,37.5,46.2,68.4,46.2s57.4-19.1,68.4-46.2h161.2c11,27.1,37.5,46.2,68.4,46.2s57.4-19.1,68.4-46.2h12.1c26.2,0,47.5-21.3,47.5-47.5v-161C560,213.3,538.7,192,512.5,192H47.5z M133,456.2c-15.1,0-27.4-12.3-27.4-27.4s12.3-27.4,27.4-27.4s27.4,12.3,27.4,27.4S148.1,456.2,133,456.2z M431,456.2c-15.1,0-27.4-12.3-27.4-27.4s12.3-27.4,27.4-27.4s27.4,12.3,27.4,27.4S446.1,456.2,431,456.2z" />
                        </svg>
                    </div>
                    <h1>LAND TRANSPORTATION OFFICE</h1>
                    <p>Vehicle Impoundment Management System</p>
                    <div class="slip-id">${data.id}</div>
                </div>

                <div class="grid">
                    <div>
                        <div class="section-title">Vehicle Information</div>
                        <div class="row"><span class="label">Plate Number</span><span class="value">${data.plate}</span></div>
                        <div class="row"><span class="label">Vehicle Type</span><span class="value">${data.type}</span></div>
                        <div class="row"><span class="label">Model</span><span class="value">${data.model}</span></div>
                        <div class="row"><span class="label">Color</span><span class="value">${data.color}</span></div>
                        <div class="row"><span class="label">Reference ID</span><span class="value">${data.ref}</span></div>
                    </div>
                    <div>
                        <div class="section-title">Owner Information</div>
                        <div class="row"><span class="label">Owner Name</span><span class="value">${data.owner}</span></div>
                        <div class="row"><span class="label">Contact</span><span class="value">${data.contact}</span></div>
                        <div class="row"><span class="label">Address</span><span class="value" style="font-size:12px; max-width:150px; text-align:right;">${data.address}</span></div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">Release Details</div>
                    <div class="row"><span class="label">Status</span><span class="value" style="color:var(--success)">${data.status}</span></div>
                    <div class="row"><span class="label">Violation</span><span class="value">${data.violation}</span></div>
                    <div class="row"><span class="label">Impounded On</span><span class="value">${data.impoundDate}</span></div>
                    <div class="row"><span class="label">Released On</span><span class="value">${data.date} at ${data.time}</span></div>
                </div>

                <div class="signatures">
                    <div class="sig-box">
                        <div class="sig-name">Officer on Duty</div>
                        <div class="sig-line"></div>
                        <div class="sig-role">Releasing Officer</div>
                    </div>
                    <div class="sig-box">
                        <div class="sig-name">${data.owner}</div>
                        <div class="sig-line"></div>
                        <div class="sig-role">Recipient Signature</div>
                    </div>
                </div>

                <div class="footer">
                    This document serves as an official release order. The vehicle described above has been cleared for release from the impound facility.<br>
                    <strong>Computer Generated Document.</strong>
                </div>
            `;
        document.getElementById("slipContent").innerHTML = html;

        // Optional: Auto-print if opened via iframe
        // window.print();
      }

      loadReleaseData();
    </script>
  </body>
</html>
