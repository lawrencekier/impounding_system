<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Audit Logs - VIS</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <link rel="stylesheet" href="sidebar.css" />

    <script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore-compat.js"></script>

    <style>
      :root {
        /* Exact Palette */
        --primary: #2563eb;
        --primary-dark: #1e40af;
        --sidebar-bg: #1e293b;
        --bg-body: #f1f5f9;
        --bg-card: #ffffff;
        --text-main: #0f172a;
        --text-muted: #64748b;
        --border: #e2e8f0;
        --danger: #ef4444;
        --success: #10b981;
        --warning: #f59e0b;

        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);

        --radius: 12px;
        --anim-speed: 0.25s;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Inter", "Segoe UI", Roboto, sans-serif;
      }

      body {
        background-color: var(--bg-body);
        display: flex;
        min-height: 100vh;
        overflow-x: hidden;
        color: var(--text-main);
      }

      /* --- Main Content --- */
      .main-content {
        flex: 1;
        margin-left: 260px; /* Matches sidebar width */
        padding: 30px 40px;
        transition: var(--anim-speed);
        padding-bottom: 80px;
        width: calc(100% - 260px);
      }

      .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 35px;
      }

      .page-title h1 {
        font-size: 26px;
        color: var(--text-main);
        font-weight: 800;
        letter-spacing: -0.5px;
      }

      .page-title p {
        color: var(--text-muted);
        font-size: 14px;
        margin-top: 4px;
      }

      /* User Menu (Pill) */
      .user-menu {
        display: flex;
        align-items: center;
        cursor: pointer;
        transition: all 0.2s;
        padding: 6px 8px 6px 16px;
        border-radius: 50px;
        background: white;
        border: 1px solid var(--border);
        box-shadow: var(--shadow-sm);
        position: relative;
      }

      .user-menu:hover {
        box-shadow: var(--shadow-md);
        border-color: var(--primary);
      }

      .user-info {
        text-align: right;
        margin-right: 12px;
      }

      .user-name {
        font-weight: 700;
        color: var(--text-main);
        font-size: 14px;
      }

      .user-role {
        font-size: 11px;
        color: var(--text-muted);
        font-weight: 600;
        text-transform: uppercase;
      }

      .user-avatar {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        background: linear-gradient(
          135deg,
          var(--primary),
          var(--primary-dark)
        );
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
      }

      .logout-dropdown {
        position: absolute;
        top: 60px;
        right: 0;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        padding: 10px;
        min-width: 200px;
        display: none;
        z-index: 1000;
        border: 1px solid var(--border);
      }

      .logout-item {
        padding: 12px 15px;
        display: flex;
        align-items: center;
        color: var(--text-main);
        text-decoration: none;
        transition: 0.2s;
        cursor: pointer;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
        font-size: 14px;
        border-radius: 8px;
      }

      .logout-item:hover {
        background-color: var(--bg-body);
        color: var(--primary);
      }

      .logout-item i {
        margin-right: 10px;
        width: 16px;
      }

      /* --- Filters Section --- */
      .filter-section {
        background: var(--bg-card);
        padding: 20px;
        border-radius: var(--radius);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border);
        margin-bottom: 25px;
      }

      .form-row {
        display: flex;
        gap: 15px;
        align-items: flex-end;
      }

      .form-col {
        flex: 1;
        min-width: 150px;
      }

      /* Button cols smaller */
      .form-col:has(button) {
        flex: 0 0 auto;
        min-width: 100px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-main);
      }

      input,
      select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 14px;
        background: #f8fafc;
        outline: none;
        transition: 0.2s;
      }

      input:focus,
      select:focus {
        border-color: var(--primary);
        background: white;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      /* --- Data Table --- */
      .data-table {
        background: var(--bg-card);
        border-radius: var(--radius);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border);
        overflow: hidden;
        margin-bottom: 20px;
      }

      .table-header {
        padding: 20px 25px;
        border-bottom: 1px solid var(--border);
        background: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .table-info {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .table-title {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-main);
      }

      .table-count {
        background: #eff6ff;
        color: var(--primary);
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        border: 1px solid #dbeafe;
      }

      .table-actions {
        display: flex;
        gap: 10px;
      }

      .btn {
        padding: 10px 20px;
        border-radius: 8px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: 0.2s;
        font-size: 14px;
      }

      .btn-primary {
        background: var(--primary);
        color: white;
      }
      .btn-primary:hover {
        background: var(--primary-dark);
      }

      .btn-outline {
        background: white;
        border: 1px solid var(--border);
        color: var(--text-muted);
        box-shadow: var(--shadow-sm);
      }
      .btn-outline:hover {
        background: var(--bg-body);
        color: var(--text-main);
        border-color: var(--primary);
      }

      .btn-small {
        padding: 6px 12px;
        font-size: 13px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        white-space: nowrap;
      }

      th {
        background: #f8fafc;
        padding: 16px 20px;
        text-align: left;
        font-weight: 600;
        color: var(--text-muted);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid var(--border);
      }

      td {
        padding: 16px 20px;
        border-bottom: 1px solid var(--border);
        font-size: 14px;
        color: var(--text-main);
        vertical-align: middle;
      }

      /* User Info Cell styling */
      .user-info-cell {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .user-info-cell i {
        color: var(--primary);
      }

      /* Action Badge */
      .action-badge {
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        display: inline-block;
        border: 1px solid transparent;
      }

      /* Specific Badge Colors based on Action Type */
      .action-badge[data-action="impounded"] {
        background: #fff7ed;
        color: #c2410c;
        border-color: #ffedd5;
      }
      .action-badge[data-action="released"] {
        background: #f0fdf4;
        color: #15803d;
        border-color: #dcfce7;
      }
      .action-badge[data-action="payment"] {
        background: #ecfdf5;
        color: #047857;
        border-color: #d1fae5;
      }
      .action-badge[data-action="user_created"],
      .action-badge[data-action="user_updated"] {
        background: #f8fafc;
        color: #475569;
        border-color: #e2e8f0;
      }
      .action-badge[data-action="login"] {
        background: #eff6ff;
        color: #1d4ed8;
        border-color: #dbeafe;
      }

      .action-cell {
        display: flex;
        gap: 8px;
        justify-content: center; /* Center the View Button */
      }

      /* --- Pagination --- */
      .pagination {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 8px;
        padding: 15px 25px;
        border-top: 1px solid var(--border);
        background: white;
      }
      
      .page-btn {
        width: 36px;
        height: 36px;
        border: 1px solid var(--border);
        background: white;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
        transition: 0.2s;
      }
      
      .page-btn:hover:not(:disabled) {
        border-color: var(--primary);
        color: var(--primary);
        background: #eff6ff;
      }
      
      .page-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      
      #pageInfo {
        font-size: 13px;
        color: var(--text-muted);
        margin: 0 10px;
      }

      /* --- Modal (Strictly Centered) --- */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        backdrop-filter: blur(4px);
      }

      /* Force Center */
      .modal[style*="display: block"],
      .modal[style*="display:block"] {
        display: flex !important;
        justify-content: center;
        align-items: center;
      }

      .modal-dialog {
        background: white;
        width: 95%;
        max-width: 700px;
        border-radius: 16px;
        padding: 0;
        box-shadow: var(--shadow-sm);
        max-height: 90vh;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        margin: 0;
      }

      .modal-header {
        padding: 20px 25px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: white;
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .modal-title {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .modal-title i {
        color: var(--primary);
        font-size: 20px;
      }

      .modal-title h3 {
        font-size: 18px;
        font-weight: 700;
        margin: 0;
        color: var(--text-main);
      }

      .close-modal {
        background: #f1f5f9;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        font-size: 18px;
        color: var(--text-muted);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .close-modal:hover {
        background: #e2e8f0;
      }

      .modal-body {
        padding: 25px;
        overflow-y: auto;
      }

      .modal-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .modal-section {
        background: #f8fafc;
        border-radius: 12px;
        padding: 20px;
        border: 1px solid var(--border);
      }

      .modal-section.full-width {
        grid-column: 1 / -1;
      }

      .section-title {
        margin: 0 0 15px 0;
        color: var(--primary);
        font-size: 14px;
        text-transform: uppercase;
        display: flex;
        align-items: center;
        gap: 8px;
        border-bottom: 1px solid var(--border);
        padding-bottom: 8px;
      }

      .detail-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        padding-bottom: 5px;
        border-bottom: 1px dashed var(--border);
      }
      .detail-row:last-child {
        border-bottom: none;
      }

      .detail-label {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
      }

      .detail-value {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-main);
        text-align: right;
      }

      /* Code block in details */
      code {
        background: #eef2ff;
        color: var(--primary);
        padding: 2px 6px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
      }

      .modal-footer {
        padding: 20px 25px;
        border-top: 1px solid var(--border);
        background: white;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      .loading-spinner {
        color: var(--text-muted);
        font-size: 14px;
      }

      .empty-state {
        text-align: center;
        padding: 40px;
        color: var(--text-muted);
      }
      .empty-state i {
        font-size: 40px;
        margin-bottom: 15px;
        opacity: 0.5;
        display: block;
      }
      .empty-state h4 {
        margin: 0 0 5px 0;
        font-size: 16px;
        color: var(--text-main);
      }
      .empty-state p {
        margin: 0;
        font-size: 13px;
      }

      @media (max-width: 900px) {
        .main-content {
          margin-left: 0;
          padding: 20px;
          width: 100%;
        }
        .form-row {
          flex-direction: column;
          align-items: stretch;
        }
        .modal-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div id="sidebar-container"></div>

    <div class="main-content">
      <div class="top-bar">
        <div class="page-title">
          <h1>Audit Logs</h1>
          <p>Monitor system activity and user actions.</p>
        </div>
        <div class="user-menu" onclick="toggleLogoutDropdown()">
          <div class="user-info">
            <div class="user-name" id="userDisplayName">Loading...</div>
            <div class="user-role" id="userRole">Administrator</div>
          </div>
          <div class="user-avatar" id="userAvatar">
            <i class="fas fa-user" id="avatarIcon"></i>
          </div>

          <div class="logout-dropdown" id="logoutDropdown">
            <button class="logout-item" onclick="viewProfile()">
              <i class="fas fa-user"></i> My Profile
            </button>
            <button class="logout-item" onclick="changePassword()">
              <i class="fas fa-key"></i> Change Password
            </button>
            <button
              class="logout-item"
              onclick="logout()"
              style="color: var(--danger)"
            >
              <i class="fas fa-sign-out-alt"></i> Logout
            </button>
          </div>
        </div>
      </div>

      <div class="filter-section">
        <div class="form-row">
          <div class="form-col">
            <label for="dateFrom">Date From</label>
            <input type="date" id="dateFrom" />
          </div>
          <div class="form-col">
            <label for="dateTo">Date To</label>
            <input type="date" id="dateTo" />
          </div>
          <div class="form-col" style="flex: 1.5">
            <label for="userFilter">User</label>
            <input
              type="text"
              id="userFilter"
              placeholder="Filter by user name"
            />
          </div>
          <div class="form-col">
            <label for="actionFilter">Action Type</label>
            <select id="actionFilter">
              <option value="">All Actions</option>
              <option value="impounded">Vehicle Impounded</option>
              <option value="released">Vehicle Released</option>
              <option value="payment">Payment Processed</option>
              <option value="user_created">User Created</option>
              <option value="user_updated">User Updated</option>
              <option value="login">User Login</option>
            </select>
          </div>
          <div class="form-col" style="flex: 0 0 auto">
            <label>&nbsp;</label>
            <button class="btn btn-primary" id="applyFilter">
              <i class="fas fa-filter"></i> Apply
            </button>
          </div>
          <div class="form-col" style="flex: 0 0 auto">
            <label>&nbsp;</label>
            <button class="btn btn-outline" id="resetFilter">
              <i class="fas fa-undo"></i> Reset
            </button>
          </div>
        </div>
      </div>

      <div class="data-table">
        <div class="table-header">
          <div class="table-info">
            <div class="table-title">System Audit Logs</div>
            <div class="table-count" id="logCount">0 logs</div>
          </div>
          <div class="table-actions">
            <button class="btn btn-outline" id="exportBtn">
              <i class="fas fa-download"></i> Export CSV
            </button>
          </div>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Log ID</th>
                <th>Timestamp</th>
                <th>User</th>
                <th>Activity</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody id="auditLogsTableBody">
              <tr>
                <td colspan="5" class="loading-state">
                  <div class="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i> Loading audit logs...
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <!-- Pagination -->
        <div class="pagination" id="pagination" style="display: none">
          <button class="page-btn" id="prevPage">
            <i class="fas fa-chevron-left"></i>
          </button>
          <span id="pageInfo">Page 1 of 1</span>
          <button class="page-btn" id="nextPage">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>

    <div id="detailModal" class="modal">
      <div class="modal-dialog">
        <div class="modal-header">
          <div class="modal-title">
            <i class="fas fa-clipboard-list"></i>
            <h3>Activity Details</h3>
          </div>
          <button class="close-modal" onclick="closeDetailModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="modal-grid">
            <div class="modal-section">
              <h4 class="section-title">
                <i class="fas fa-info-circle"></i>
                Activity Information
              </h4>
              <div class="detail-row">
                <div class="detail-label">Log ID</div>
                <div class="detail-value" id="detailLogId">-</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">Action Type</div>
                <div class="detail-value">
                  <span class="action-badge" id="detailAction">-</span>
                </div>
              </div>
              <div class="detail-row">
                <div class="detail-label">User</div>
                <div class="detail-value">
                  <i class="fas fa-user"></i>
                  <span id="detailFullName">-</span>
                </div>
              </div>
              <div class="detail-row">
                <div class="detail-label">User ID</div>
                <div class="detail-value" id="detailUserId">-</div>
              </div>
            </div>

            <div class="modal-section">
              <h4 class="section-title">
                <i class="fas fa-calendar-alt"></i>
                Date & Time
              </h4>
              <div class="detail-row">
                <div class="detail-label">Timestamp</div>
                <div class="detail-value">
                  <i class="fas fa-clock"></i>
                  <span id="detailTimestamp">-</span>
                </div>
              </div>
              <div class="detail-row">
                <div class="detail-label">Date</div>
                <div class="detail-value" id="detailDate">-</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">Time</div>
                <div class="detail-value" id="detailTime">-</div>
              </div>
            </div>

            <div class="modal-section">
              <h4 class="section-title">
                <i class="fas fa-car"></i>
                Vehicle Information
              </h4>
              <div class="detail-row">
                <div class="detail-label">Vehicle</div>
                <div class="detail-value" id="detailVehicleId">
                  No vehicle associated
                </div>
              </div>
            </div>

            <div class="modal-section full-width">
              <h4 class="section-title">
                <i class="fas fa-file-alt"></i>
                Additional Details
              </h4>
              <div class="detail-row">
                <div class="detail-label">Description</div>
                <div class="detail-value" id="detailDetails">-</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">Document ID</div>
                <div class="detail-value">
                  <code id="detailDocumentId">-</code>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-outline"
            onclick="closeDetailModal()"
          >
            <i class="fas fa-times"></i> Close
          </button>
          <button
            type="button"
            class="btn btn-primary"
            onclick="printDetails()"
          >
            <i class="fas fa-print"></i> Print Details
          </button>
        </div>
      </div>
    </div>

    <script>
      // Firebase Configuration
      const firebaseConfig = {
        apiKey: "AIzaSyByzd88bcUAq0VdP0w6oB8W_b2AUgoIzXc",
        authDomain: "vehicle-impound.firebaseapp.com",
        projectId: "vehicle-impound",
        storageBucket: "vehicle-impound.firebasestorage.app",
        messagingSenderId: "69239563292",
        appId: "1:69239563292:web:281912e8a38301c0feabd9",
      };

      // Initialize Firebase
      console.log("Initializing Firebase...");
      let db, auth;
      let currentUser = null;
      let allLogs = [];
      let vehicleCache = new Map();
      let filteredLogs = [];

      // Pagination variables
      let currentPage = 1;
      const itemsPerPage = 10; // Show 10 logs per page
      
      // Pagination elements
      const pagination = document.getElementById("pagination");
      const prevPageBtn = document.getElementById("prevPage");
      const nextPageBtn = document.getElementById("nextPage");
      const pageInfo = document.getElementById("pageInfo");

      // Application State
      const appState = {
        currentFilter: {
          dateFrom: null,
          dateTo: null,
          user: "",
          action: "",
        },
      };

      try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        auth = firebase.auth();
        console.log("‚úÖ Firebase initialized successfully");
      } catch (error) {
        console.error("‚ùå Firebase initialization error:", error);
        showErrorMessage("Firebase initialization failed: " + error.message);
      }

      // Initialize the application
      document.addEventListener("DOMContentLoaded", function () {
        console.log("DOM Content Loaded");

        // 1. FETCH THE SIDEBAR
        fetch("sidebar.html")
          .then((response) => {
            if (!response.ok) throw new Error("Sidebar not found");
            return response.text();
          })
          .then((data) => {
            // Inject the HTML
            document.getElementById("sidebar-container").innerHTML = data;

            // Highlight the "Audit Logs" link
            highlightActiveLink();
          })
          .catch((error) => console.error("Error loading sidebar:", error));

        // 2. INITIALIZE APP
        initializeApp();
        
        // 3. Set up pagination event listeners
        prevPageBtn.addEventListener("click", () => changePage(-1));
        nextPageBtn.addEventListener("click", () => changePage(1));
      });

      // --- SIDEBAR HELPER FUNCTION ---
      function highlightActiveLink() {
        // Current Page: audit-logs.html
        const page = "audit-logs.html";

        const links = document.querySelectorAll(".sidebar-menu a");

        links.forEach((link) => {
          const href = link.getAttribute("href");
          if (href === page) {
            link.classList.add("active");
          } else {
            link.classList.remove("active");
          }
        });
      }

      async function initializeApp() {
        try {
          // Check auth
          auth.onAuthStateChanged(async (user) => {
            if (user) {
              currentUser = user;
              console.log("User authenticated:", user.email);
              await loadUserData(user.uid);
              setupEventListeners();
              await loadAuditLogs();
              updateLogCount();
            } else {
              console.log("No user authenticated, redirecting to login...");
              window.location.href = "../index.html";
            }
          });
        } catch (error) {
          console.error("Error initializing app:", error);
          showError("Error initializing application: " + error.message);
        }
      }

      async function loadUserData(userId) {
        try {
          const userDoc = await db.collection("users").doc(userId).get();
          if (userDoc.exists) {
            const userData = userDoc.data();
            document.getElementById("userDisplayName").textContent =
              userData.fullName || "Admin User";
            document.getElementById("userRole").textContent =
              formatRole(userData.role) || "System Administrator";

            if (userData.fullName) {
              const initials = getInitials(userData.fullName);
              document.getElementById("avatarIcon").parentElement.innerHTML =
                initials;
            }
          }
        } catch (error) {
          console.error("Error loading user data:", error);
        }
      }

      // Top-bar dropdown functionality
      function toggleLogoutDropdown() {
        const dropdown = document.getElementById("logoutDropdown");
        dropdown.style.display =
          dropdown.style.display === "block" ? "none" : "block";
      }

      // Close dropdown when clicking outside
      document.addEventListener("click", function (event) {
        const dropdown = document.getElementById("logoutDropdown");
        const userAvatar = document.getElementById("userAvatar");

        if (
          userAvatar &&
          !userAvatar.contains(event.target) &&
          dropdown &&
          !dropdown.contains(event.target)
        ) {
          dropdown.style.display = "none";
        }
      });

      // Dropdown menu functions
      function viewProfile() {
        alert("Profile view functionality would go here");
        document.getElementById("logoutDropdown").style.display = "none";
      }

      function changePassword() {
        alert("Change password functionality would go here");
        document.getElementById("logoutDropdown").style.display = "none";
      }

      async function logout() {
        if (confirm("Are you sure you want to logout?")) {
          try {
            await auth.signOut();
            window.location.href = "../index.html";
          } catch (error) {
            console.error("Error during logout:", error);
          }
        }
      }

      function getInitials(fullName) {
        return fullName
          .split(" ")
          .map((name) => name[0])
          .join("")
          .toUpperCase()
          .substring(0, 2);
      }

      function formatRole(role) {
        const roleMap = {
          admin: "Administrator",
          officer: "Impounding Officer",
          cashier: "Cashier",
          releasing: "Releasing Officer",
        };
        return roleMap[role] || role;
      }

      function setupEventListeners() {
        console.log("Setting up event listeners");

        document
          .getElementById("applyFilter")
          .addEventListener("click", applyFilters);
        document
          .getElementById("resetFilter")
          .addEventListener("click", resetFilters);
        document
          .getElementById("exportBtn")
          .addEventListener("click", exportData);

        // Set default date range (last 30 days)
        const today = new Date();
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(today.getDate() - 30);

        const dateFromInput = document.getElementById("dateFrom");
        const dateToInput = document.getElementById("dateTo");

        dateFromInput.value = thirtyDaysAgo.toISOString().split("T")[0];
        dateToInput.value = today.toISOString().split("T")[0];

        // Save filter state
        appState.currentFilter.dateFrom = dateFromInput.value;
        appState.currentFilter.dateTo = dateToInput.value;

        // Update filter state on input change
        dateFromInput.addEventListener("change", (e) => {
          appState.currentFilter.dateFrom = e.target.value;
        });

        dateToInput.addEventListener("change", (e) => {
          appState.currentFilter.dateTo = e.target.value;
        });

        document.getElementById("userFilter").addEventListener("input", (e) => {
          appState.currentFilter.user = e.target.value;
        });

        document
          .getElementById("actionFilter")
          .addEventListener("change", (e) => {
            appState.currentFilter.action = e.target.value;
          });

        // Close modal when clicking outside
        window.addEventListener("click", function (event) {
          const modal = document.getElementById("detailModal");
          if (event.target === modal) {
            closeDetailModal();
          }
        });

        // Add keyboard shortcuts
        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape") {
            closeDetailModal();
            const dropdown = document.getElementById("logoutDropdown");
            if (dropdown) dropdown.style.display = "none";
          }
        });
      }

      async function loadAuditLogs() {
        showLoading();
        console.log("Loading audit logs from Firestore...");

        try {
          const querySnapshot = await db
            .collection("activityLogs")
            .orderBy("timestamp", "desc")
            .get();

          console.log(
            `‚úÖ Successfully retrieved ${querySnapshot.size} audit logs`
          );

          allLogs = [];
          querySnapshot.forEach((doc) => {
            const logData = doc.data();
            allLogs.push({
              id: doc.id,
              ...logData,
            });
          });

          if (allLogs.length === 0) {
            console.log("‚ÑπÔ∏è No audit logs found in activityLog collection");
            showEmptyState();
          } else {
            console.log(`üìä Displaying ${allLogs.length} audit logs`);
            currentPage = 1; // Reset to first page
            filteredLogs = [...allLogs];
            renderLogsTable();
          }

          updateLogCount();
        } catch (error) {
          console.error("‚ùå Error loading audit logs:", error);
          showErrorMessage("Error loading audit logs: " + error.message);
        }
      }

      function renderLogsTable() {
        const tbody = document.getElementById("auditLogsTableBody");
        
        if (filteredLogs.length === 0) {
          tbody.innerHTML = `
            <tr>
                <td colspan="5" class="empty-state">
                    <i class="fas fa-search"></i>
                    <h4>No Results Found</h4>
                    <p>No audit logs match your current filters. Try adjusting your search criteria.</p>
                </td>
            </tr>
          `;
          pagination.style.display = "none";
          return;
        }

        // Calculate pagination
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageLogs = filteredLogs.slice(start, end);
        const totalPages = Math.ceil(filteredLogs.length / itemsPerPage);
        
        let tableHTML = "";

        pageLogs.forEach((log, index) => {
          // Calculate absolute index for log ID
          const absoluteIndex = start + index + 1;
          const timestamp = formatTimestamp(log.timestamp);
          const logId = `LOG-${absoluteIndex.toString().padStart(4, "0")}`;
          const actionBadge = getActionBadge(log.action);

          tableHTML += `
            <tr>
                <td><strong>${logId}</strong></td>
                <td>${timestamp}</td>
                <td>
                    <div class="user-info-cell">
                        <i class="fas fa-user-circle"></i>
                        <span>${log.fullName || "Unknown"}</span>
                    </div>
                </td>
                <td>${actionBadge}</td>
                <td class="action-cell">
                    <button class="btn btn-small btn-outline view-details" data-index="${start + index}" title="View Details">
                        <i class="fas fa-eye"></i> View
                    </button>
                </td>
            </tr>
          `;
        });

        tbody.innerHTML = tableHTML;

        // Add event listeners to view buttons
        document.querySelectorAll(".view-details").forEach((button) => {
          button.addEventListener("click", function () {
            const logIndex = this.getAttribute("data-index");
            showLogDetails(logIndex);
          });
        });

        // Update pagination
        updatePagination(totalPages);
        
        console.log(`‚úÖ Table populated with ${pageLogs.length} rows (Page ${currentPage}/${totalPages})`);
      }
      
      function updatePagination(totalPages) {
        if (totalPages > 1) {
          pagination.style.display = "flex";
          pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
          prevPageBtn.disabled = currentPage === 1;
          nextPageBtn.disabled = currentPage === totalPages;
        } else {
          pagination.style.display = "none";
        }
      }
      
      function changePage(dir) {
        const totalPages = Math.ceil(filteredLogs.length / itemsPerPage);
        currentPage += dir;
        if (currentPage < 1) currentPage = 1;
        if (currentPage > totalPages) currentPage = totalPages;
        renderLogsTable();
        // Scroll to top of table
        document.querySelector('.data-table').scrollIntoView({ behavior: 'smooth' });
      }

      function getActionBadge(action) {
        const actionMap = {
          impounded: { text: "Vehicle Impounded", class: "impounded" },
          released: { text: "Vehicle Released", class: "released" },
          payment: { text: "Payment Processed", class: "payment" },
          user_created: { text: "User Created", class: "user_created" },
          user_updated: { text: "User Updated", class: "user_updated" },
          login: { text: "User Login", class: "login" },
        };

        const actionInfo = actionMap[action] || {
          text: action,
          class: "default",
        };
        return `<span class="action-badge" data-action="${actionInfo.class}">${actionInfo.text}</span>`;
      }

      function formatAction(action) {
        const actionMap = {
          impounded: "Vehicle Impounded",
          released: "Vehicle Released",
          payment: "Payment Processed",
          user_created: "User Created",
          user_updated: "User Updated",
          login: "User Login",
        };
        return actionMap[action] || action;
      }

      function applyFilters() {
        console.log("Applying filters...");

        let tempFilteredLogs = [...allLogs];

        // Date filter
        const dateFrom = appState.currentFilter.dateFrom
          ? new Date(appState.currentFilter.dateFrom)
          : null;
        const dateTo = appState.currentFilter.dateTo
          ? new Date(appState.currentFilter.dateTo + "T23:59:59")
          : null;

        if (dateFrom && dateTo) {
          tempFilteredLogs = tempFilteredLogs.filter((log) => {
            const logDate = new Date(log.timestamp);
            return logDate >= dateFrom && logDate <= dateTo;
          });
        }

        // User filter
        const selectedUser = appState.currentFilter.user;
        if (selectedUser) {
          tempFilteredLogs = tempFilteredLogs.filter((log) => {
            const userName = log.fullName || "";
            return userName.toLowerCase().includes(selectedUser.toLowerCase());
          });
        }

        // Action filter
        const selectedAction = appState.currentFilter.action;
        if (selectedAction) {
          tempFilteredLogs = tempFilteredLogs.filter((log) => {
            return log.action === selectedAction;
          });
        }

        console.log(
          `Applied filters: ${tempFilteredLogs.length} logs match criteria`
        );
        filteredLogs = tempFilteredLogs;
        currentPage = 1; // Reset to first page when applying filters
        renderLogsTable();
        updateLogCount();
      }

      function resetFilters() {
        console.log("Resetting filters...");

        const today = new Date();
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(today.getDate() - 30);

        document.getElementById("dateFrom").value = thirtyDaysAgo
          .toISOString()
          .split("T")[0];
        document.getElementById("dateTo").value = today
          .toISOString()
          .split("T")[0];
        document.getElementById("userFilter").value = "";
        document.getElementById("actionFilter").value = "";

        appState.currentFilter = {
          dateFrom: thirtyDaysAgo.toISOString().split("T")[0],
          dateTo: today.toISOString().split("T")[0],
          user: "",
          action: "",
        };

        filteredLogs = [...allLogs];
        currentPage = 1;
        renderLogsTable();
        updateLogCount();
      }

      async function getVehicleInfo(vehicleId) {
        if (!vehicleId) return "N/A";

        if (vehicleCache.has(vehicleId)) {
          return vehicleCache.get(vehicleId);
        }

        try {
          const vehicleDoc = await db
            .collection("impoundedVehicles")
            .doc(vehicleId)
            .get();

          if (vehicleDoc.exists) {
            const vehicleData = vehicleDoc.data();
            let readableInfo = "N/A";

            if (vehicleData.plateNumber) {
              readableInfo = vehicleData.plateNumber;
              if (vehicleData.vehicleMake || vehicleData.vehicleModel) {
                readableInfo += ` (${vehicleData.vehicleMake || ""} ${
                  vehicleData.vehicleModel || ""
                })`.trim();
              }
            } else if (vehicleData.vehicleMake || vehicleData.vehicleModel) {
              readableInfo = `${vehicleData.vehicleMake || ""} ${
                vehicleData.vehicleModel || ""
              }`.trim();
            } else if (vehicleData.readableId) {
              readableInfo = vehicleData.readableId;
            }

            vehicleCache.set(vehicleId, readableInfo);
            return readableInfo;
          } else {
            vehicleCache.set(vehicleId, `Vehicle ID: ${vehicleId}`);
            return `Vehicle ID: ${vehicleId}`;
          }
        } catch (error) {
          console.error("Error fetching vehicle info:", error);
          return `Vehicle ID: ${vehicleId}`;
        }
      }

      async function showLogDetails(logIndex) {
        try {
          const log = allLogs[logIndex];

          if (log) {
            // Calculate log ID based on position in filtered results
            const logPosition = filteredLogs.findIndex(l => l.id === log.id);
            const logId = logPosition !== -1 
              ? `LOG-${(logPosition + 1).toString().padStart(4, "0")}`
              : `LOG-${(parseInt(logIndex) + 1).toString().padStart(4, "0")}`;
            
            const vehicleInfo = await getVehicleInfo(log.vehicleId);
            const timestamp = new Date(log.timestamp);

            // Format date and time separately
            const dateString = timestamp.toLocaleDateString("en-US", {
              year: "numeric",
              month: "long",
              day: "numeric",
            });

            const timeString = timestamp.toLocaleTimeString("en-US", {
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit",
            });

            // Update modal content
            document.getElementById("detailLogId").textContent = logId;

            const actionBadge = document.getElementById("detailAction");
            actionBadge.textContent = formatAction(log.action);
            actionBadge.setAttribute("data-action", log.action || "default");

            document.getElementById("detailFullName").textContent =
              log.fullName || "N/A";
            document.getElementById("detailUserId").textContent =
              log.userId || "N/A";
            document.getElementById(
              "detailTimestamp"
            ).textContent = `${dateString} ${timeString}`;
            document.getElementById("detailDate").textContent = dateString;
            document.getElementById("detailTime").textContent = timeString;
            document.getElementById("detailVehicleId").textContent =
              vehicleInfo;
            document.getElementById("detailDetails").textContent =
              log.details || "No additional details";
            document.getElementById("detailDocumentId").textContent =
              log.id || "N/A";

            // Show modal with animation
            const modal = document.getElementById("detailModal");
            modal.style.display = "block";
            document.body.style.overflow = "hidden"; // Prevent scrolling
          }
        } catch (error) {
          console.error("Error showing log details:", error);
          showError("Error loading log details: " + error.message);
        }
      }

      function closeDetailModal() {
        const modal = document.getElementById("detailModal");
        modal.style.display = "none";
        document.body.style.overflow = ""; // Restore scrolling
      }

      function printDetails() {
        window.print();
      }

      async function exportData() {
        if (filteredLogs.length === 0) {
          alert("No data to export");
          return;
        }

        try {
          const exportBtn = document.getElementById("exportBtn");
          const originalText = exportBtn.innerHTML;
          exportBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> Exporting...';
          exportBtn.disabled = true;

          let csvContent = "data:text/csv;charset=utf-8,";
          csvContent +=
            "Log ID,Timestamp,Date,Time,User,Action,Details,User ID,Vehicle Info,Document ID\n";

          for (let i = 0; i < filteredLogs.length; i++) {
            const log = filteredLogs[i];
            const logId = `LOG-${(i + 1).toString().padStart(4, "0")}`;
            const vehicleInfo = await getVehicleInfo(log.vehicleId);
            const timestamp = new Date(log.timestamp);

            const dateString = timestamp.toLocaleDateString("en-US");
            const timeString = timestamp.toLocaleTimeString("en-US");

            const row = [
              logId,
              `${dateString} ${timeString}`,
              dateString,
              timeString,
              `"${(log.fullName || "").replace(/"/g, '""')}"`,
              formatAction(log.action),
              `"${(log.details || "").replace(/"/g, '""')}"`,
              log.userId || "",
              `"${vehicleInfo.replace(/"/g, '""')}"`,
              log.id || "",
            ].join(",");
            csvContent += row + "\n";
          }

          const encodedUri = encodeURI(csvContent);
          const link = document.createElement("a");
          link.setAttribute("href", encodedUri);
          link.setAttribute(
            "download",
            `audit_logs_${new Date().toISOString().split("T")[0]}.csv`
          );
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

          console.log(`‚úÖ Exported ${filteredLogs.length} logs to CSV`);
        } catch (error) {
          console.error("Error exporting data:", error);
          showError("Error exporting data: " + error.message);
        } finally {
          const exportBtn = document.getElementById("exportBtn");
          exportBtn.innerHTML = '<i class="fas fa-download"></i> Export CSV';
          exportBtn.disabled = false;
        }
      }

      function formatTimestamp(timestampString, fullFormat = false) {
        if (!timestampString) return "N/A";

        const date = new Date(timestampString);

        if (isNaN(date.getTime())) return "Invalid Date";

        if (fullFormat) {
          return date.toLocaleString("en-US", {
            year: "numeric",
            month: "long",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
          });
        } else {
          return (
            date.toLocaleDateString("en-US", {
              year: "numeric",
              month: "2-digit",
              day: "2-digit",
            }) +
            " " +
            date.toLocaleTimeString("en-US", {
              hour: "2-digit",
              minute: "2-digit",
            })
          );
        }
      }

      function updateLogCount() {
        const countElement = document.getElementById("logCount");
        countElement.textContent = `${filteredLogs.length} ${
          filteredLogs.length === 1 ? "log" : "logs"
        }`;
      }

      function showLoading() {
        const tbody = document.getElementById("auditLogsTableBody");
        tbody.innerHTML = `
        <tr>
            <td colspan="5" class="loading-state">
                <div class="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i> Loading audit logs...
                </div>
            </td>
        </tr>
    `;
        pagination.style.display = "none";
      }

      function showEmptyState() {
        const tbody = document.getElementById("auditLogsTableBody");
        tbody.innerHTML = `
        <tr>
            <td colspan="5" class="empty-state">
                <i class="fas fa-inbox"></i>
                <h4>No Audit Logs Found</h4>
                <p>The audit logs collection is empty. System activities will appear here as they occur.</p>
            </td>
        </tr>
    `;
        pagination.style.display = "none";
      }

      function showErrorMessage(message) {
        const tbody = document.getElementById("auditLogsTableBody");
        tbody.innerHTML = `
        <tr>
            <td colspan="5" class="error-message">
                <i class="fas fa-exclamation-triangle"></i> ${message}
                <br><br>
                <button class="btn btn-small btn-outline" onclick="loadAuditLogs()">
                    <i class="fas fa-redo"></i> Retry
                </button>
            </td>
        </tr>
    `;
        pagination.style.display = "none";
      }

      function showError(message) {
        // Create a more user-friendly error notification
        const notification = document.createElement("div");
        notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #dc3545;
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 9999;
        display: flex;
        align-items: center;
        gap: 10px;
        animation: slideIn 0.3s ease-out;
    `;

        notification.innerHTML = `
        <i class="fas fa-exclamation-circle"></i>
        <div>
            <strong>Error:</strong> ${message}
        </div>
        <button style="background: transparent; border: none; color: white; cursor: pointer; margin-left: 10px;" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
    `;

        document.body.appendChild(notification);

        // Auto-remove after 5 seconds
        setTimeout(() => {
          if (notification.parentNode) {
            notification.remove();
          }
        }, 5000);
      }

      // Utility function to add CSS for user info cell
      function addUserInfoCellStyles() {
        if (!document.querySelector("#user-cell-styles")) {
          const style = document.createElement("style");
          style.id = "user-cell-styles";
          style.textContent = `
            .user-info-cell {
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .user-info-cell i {
                color: var(--primary);
            }
        `;
          document.head.appendChild(style);
        }
      }

      // Initialize user cell styles
      addUserInfoCellStyles();
    </script>
  </body>
</html>