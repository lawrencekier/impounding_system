<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Impound Records - VIS</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <link rel="stylesheet" href="sidebar.css" />

    <style>
      :root {
        /* Exact Palette */
        --primary: #2563eb;
        --primary-dark: #1e40af;
        --sidebar-bg: #1e293b;
        --bg-body: #f1f5f9;
        --bg-card: #ffffff;
        --text-main: #0f172a;
        --text-muted: #64748b;
        --border: #e2e8f0;
        --danger: #ef4444;
        --success: #10b981;
        --warning: #f59e0b;

        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);

        --radius: 12px;
        --anim-speed: 0.25s;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Inter", "Segoe UI", Roboto, sans-serif;
      }

      body {
        background-color: var(--bg-body);
        display: flex;
        min-height: 100vh;
        overflow-x: hidden;
        color: var(--text-main);
      }

      /* --- Main Content --- */
      .main-content {
        flex: 1;
        margin-left: 260px; /* Matches sidebar width */
        padding: 30px 40px;
        transition: var(--anim-speed);
        padding-bottom: 80px;
        width: calc(100% - 260px);
      }

      .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 35px;
      }

      .page-title h1 {
        font-size: 26px;
        color: var(--text-main);
        font-weight: 800;
        letter-spacing: -0.5px;
      }

      .page-title p {
        color: var(--text-muted);
        font-size: 14px;
        margin-top: 4px;
      }

      /* User Menu (Pill) */
      .user-menu {
        display: flex;
        align-items: center;
        cursor: pointer;
        transition: all 0.2s;
        padding: 6px 8px 6px 16px;
        border-radius: 50px;
        background: white;
        border: 1px solid var(--border);
        box-shadow: var(--shadow-sm);
        position: relative;
      }

      .user-menu:hover {
        box-shadow: var(--shadow-md);
        border-color: var(--primary);
      }

      .user-info {
        text-align: right;
        margin-right: 12px;
      }

      .user-name {
        font-weight: 700;
        color: var(--text-main);
        font-size: 14px;
      }

      .user-role {
        font-size: 11px;
        color: var(--text-muted);
        font-weight: 600;
        text-transform: uppercase;
      }

      .user-avatar {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        background: linear-gradient(
          135deg,
          var(--primary),
          var(--primary-dark)
        );
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
      }

      .logout-dropdown {
        position: absolute;
        top: 60px;
        right: 0;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        padding: 10px;
        min-width: 200px;
        display: none;
        z-index: 1000;
        border: 1px solid var(--border);
      }

      .logout-item {
        padding: 12px 15px;
        display: flex;
        align-items: center;
        color: var(--text-main);
        text-decoration: none;
        transition: 0.2s;
        cursor: pointer;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
        font-size: 14px;
        border-radius: 8px;
      }

      .logout-item:hover {
        background-color: var(--bg-body);
        color: var(--primary);
      }

      .logout-item i {
        margin-right: 10px;
        width: 16px;
      }

      /* --- Filters Section --- */
      .filters-section {
        background: var(--bg-card);
        padding: 20px;
        border-radius: var(--radius);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border);
        margin-bottom: 25px;
      }

      .form-row {
        display: flex;
        gap: 15px;
        align-items: flex-end; /* Align buttons with inputs */
      }

      .form-col {
        flex: 1;
      }

      /* Allow buttons to be smaller in the row */
      .form-col:has(button) {
        flex: 0 0 auto;
        min-width: 120px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-main);
      }

      input,
      select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 14px;
        background: #f8fafc;
        outline: none;
        transition: 0.2s;
      }

      input:focus,
      select:focus {
        border-color: var(--primary);
        background: white;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      /* --- Data Table --- */
      .data-table {
        background: var(--bg-card);
        border-radius: var(--radius);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border);
        overflow: hidden;
        margin-bottom: 20px;
      }

      .table-header {
        padding: 20px 25px;
        border-bottom: 1px solid var(--border);
        background: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .table-title {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-main);
      }

      .table-actions {
        display: flex;
        gap: 10px;
      }

      .btn {
        padding: 10px 20px;
        border-radius: 8px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: 0.2s;
        font-size: 14px;
      }

      .btn-primary {
        background: var(--primary);
        color: white;
      }
      .btn-primary:hover {
        background: var(--primary-dark);
      }

      .btn-outline {
        background: white;
        border: 1px solid var(--border);
        color: var(--text-muted);
        box-shadow: var(--shadow-sm);
      }
      .btn-outline:hover {
        background: var(--bg-body);
        color: var(--text-main);
        border-color: var(--primary);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        white-space: nowrap;
      }

      th {
        background: #f8fafc;
        padding: 16px 20px;
        text-align: left;
        font-weight: 600;
        color: var(--text-muted);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid var(--border);
      }

      td {
        padding: 16px 20px;
        border-bottom: 1px solid var(--border);
        font-size: 14px;
        color: var(--text-main);
        vertical-align: middle;
      }

      /* Center amount/status columns */
      .data-table table th:nth-child(4),
      .data-table table th:nth-child(5),
      .data-table table th:nth-child(6),
      .data-table table th:nth-child(7),
      .data-table table td:nth-child(4),
      .data-table table td:nth-child(5),
      .data-table table td:nth-child(6),
      .data-table table td:nth-child(7) {
        text-align: center;
      }

      /* Status Badges */
      .status {
        padding: 6px 12px;
        border-radius: 30px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        display: inline-block;
      }

      .status-impounded,
      .status-pending {
        background: #fef9c3;
        color: #854d0e;
        border: 1px solid #fde047;
      }

      .status-paid,
      .status-released,
      .status-approved {
        background: #dcfce7;
        color: #166534;
        border: 1px solid #86efac;
      }

      .action-cell {
        display: flex;
        gap: 8px;
        justify-content: center;
      }

      .action-icon-btn {
        width: 34px;
        height: 34px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: 0.2s;
        font-size: 14px;
        border: 1px solid transparent;
      }

      .action-view {
        background: #f0f9ff;
        color: var(--primary);
        border-color: #bae6fd;
      }
      .action-view:hover {
        background: var(--primary);
        color: white;
      }

      /* --- Pagination --- */
      .pagination {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 8px;
        padding: 15px 25px;
        border-top: 1px solid var(--border);
        background: white;
      }

      .page-btn {
        width: 36px;
        height: 36px;
        border: 1px solid var(--border);
        background: white;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
        transition: 0.2s;
      }

      .page-btn:hover:not(:disabled) {
        border-color: var(--primary);
        color: var(--primary);
        background: #eff6ff;
      }

      .page-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      #pageInfo {
        font-size: 13px;
        color: var(--text-muted);
        margin: 0 10px;
      }

      /* --- Modals --- */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        backdrop-filter: blur(4px);
      }

      /* Force Center */
      .modal[style*="display: block"],
      .modal[style*="display:block"] {
        display: flex !important;
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background: white;
        width: 95%;
        max-width: 800px;
        border-radius: 16px;
        padding: 0;
        box-shadow: var(--shadow-sm);
        max-height: 90vh;
        overflow-y: auto;
        margin: 0;
        display: flex;
        flex-direction: column;
      }

      .modal-header {
        padding: 20px 25px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: white;
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .modal-header h3 {
        font-size: 18px;
        font-weight: 700;
        margin: 0;
        color: var(--text-main);
      }

      .close-modal {
        background: #f1f5f9;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        font-size: 20px;
        color: var(--text-muted);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
      }

      .close-modal:hover {
        background: #e2e8f0;
      }

      .modal-body {
        padding: 25px;
        overflow-y: auto;
      }

      .vehicle-details-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      /* Summary Card in Modal */
      .summary-card {
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-dark) 100%
        );
        color: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 10px;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
      }

      .summary-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .summary-header h4 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      /* Override status badge inside summary card */
      .summary-header .status {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
      }

      .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
      }

      .summary-item {
        display: flex;
        flex-direction: column;
      }

      .summary-label {
        font-size: 12px;
        opacity: 0.8;
        margin-bottom: 4px;
        text-transform: uppercase;
      }

      .summary-value {
        font-size: 15px;
        font-weight: 600;
      }

      .summary-value.amount {
        font-size: 18px;
      }

      /* Info Sections */
      .info-section {
        background: #f8fafc;
        border-radius: 12px;
        padding: 20px;
        border: 1px solid var(--border);
      }

      .info-section h4 {
        margin: 0 0 15px 0;
        color: var(--primary);
        font-size: 14px;
        text-transform: uppercase;
        display: flex;
        align-items: center;
        gap: 8px;
        border-bottom: 1px solid var(--border);
        padding-bottom: 8px;
      }

      .info-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }

      .info-item {
        display: flex;
        flex-direction: column;
      }

      .info-label {
        font-size: 11px;
        color: var(--text-muted);
        margin-bottom: 4px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .info-value {
        font-size: 14px;
        color: var(--text-main);
        font-weight: 500;
      }

      /* Two Column Layout */
      .two-column-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      /* Violation Items */
      .violation-item {
        display: flex;
        align-items: center;
        padding: 12px;
        background: white;
        border: 1px dashed var(--border);
        border-radius: 8px;
        margin-bottom: 8px;
      }

      .violation-code {
        background: #eff6ff;
        color: var(--primary);
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 700;
        margin-right: 12px;
      }

      .violation-details {
        flex: 1;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .violation-description {
        font-size: 14px;
        font-weight: 500;
      }

      .violation-penalty {
        text-align: right;
      }

      .violation-penalty .fine {
        color: var(--danger);
        font-weight: 700;
        display: block;
      }

      .violation-penalty .points {
        font-size: 11px;
        color: var(--text-muted);
      }

      .modal-actions {
        padding: 20px 25px;
        border-top: 1px solid var(--border);
        background: white;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      .loading-spinner {
        color: var(--text-muted);
        font-size: 14px;
      }

      @media (max-width: 900px) {
        .main-content {
          margin-left: 0;
          padding: 20px;
          width: 100%;
        }
        .form-row {
          flex-direction: column;
          gap: 15px;
        }
        .form-col {
          width: 100%;
        }
        .two-column-layout {
          grid-template-columns: 1fr;
        }
      }
    </style>

    <script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore-compat.js"></script>
  </head>
  <body>
    <div id="sidebar-container"></div>

    <div class="main-content">
      <div class="top-bar">
        <div class="page-title">
          <h1>Impound Records</h1>
          <p>View and manage all impounded vehicle records.</p>
        </div>
        <div class="user-menu" onclick="toggleLogoutDropdown()">
          <div class="user-info">
            <div class="user-name" id="userDisplayName">Loading...</div>
            <div class="user-role" id="userRole">Administrator</div>
          </div>
          <div class="user-avatar" id="userAvatar">
            <i class="fas fa-user" id="avatarIcon"></i>
          </div>

          <div class="logout-dropdown" id="logoutDropdown">
            <button class="logout-item" onclick="viewProfile()">
              <i class="fas fa-user"></i> My Profile
            </button>
            <button class="logout-item" onclick="changePassword()">
              <i class="fas fa-key"></i> Change Password
            </button>
            <button
              class="logout-item"
              onclick="logout()"
              style="color: var(--danger)"
            >
              <i class="fas fa-sign-out-alt"></i> Logout
            </button>
          </div>
        </div>
      </div>

      <div class="filters-section">
        <div class="form-row">
          <div class="form-col">
            <label>Status</label>
            <select id="statusFilter">
              <option value="">All Status</option>
              <option value="impounded">Impounded</option>
              <option value="paid">Paid</option>
              <option value="approved">Approved for Release</option>
              <option value="released">Released</option>
            </select>
          </div>
          <div class="form-col">
            <label>Date From</label>
            <input type="date" id="dateFrom" />
          </div>
          <div class="form-col">
            <label>Date To</label>
            <input type="date" id="dateTo" />
          </div>
          <div class="form-col" style="flex: 1.5">
            <label>Search</label>
            <input
              type="text"
              id="searchFilter"
              placeholder="Plate number or reference..."
            />
          </div>
          <div class="form-col" style="flex: 0 0 auto">
            <label>&nbsp;</label>
            <button class="btn btn-primary" id="applyFilter">
              <i class="fas fa-filter"></i> Apply
            </button>
          </div>
          <div class="form-col" style="flex: 0 0 auto">
            <label>&nbsp;</label>
            <button class="btn btn-outline" id="clearFilter">
              <i class="fas fa-times"></i> Clear
            </button>
          </div>
        </div>
      </div>

      <div class="data-table">
        <div class="table-header">
          <div class="table-title">All Impounded Vehicles</div>
          <div class="table-actions">
            <button class="btn btn-outline" id="refreshBtn">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <button class="btn btn-primary" id="exportBtn">
              <i class="fas fa-download"></i> Export
            </button>
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th>Ref. No.</th>
              <th>Plate Number</th>
              <th>Vehicle Type</th>
              <th>Fine Amount</th>
              <th>Date Impounded</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="impoundedVehiclesTableBody">
            <tr>
              <td
                colspan="7"
                style="
                  text-align: center;
                  padding: 40px;
                  color: var(--text-muted);
                "
              >
                <div class="loading-spinner">
                  <i class="fas fa-spinner fa-spin"></i> Loading impounded
                  vehicles...
                </div>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Pagination -->
        <div class="pagination" id="pagination" style="display: none">
          <button class="page-btn" id="prevPage">
            <i class="fas fa-chevron-left"></i>
          </button>
          <span id="pageInfo">Page 1 of 1</span>
          <button class="page-btn" id="nextPage">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>

    <div id="vehicleDetailsModal" class="modal" style="display: none"></div>

    <script>
      // Firebase Configuration
      const firebaseConfig = {
        apiKey: "AIzaSyByzd88bcUAq0VdP0w6oB8W_b2AUgoIzXc",
        authDomain: "vehicle-impound.firebaseapp.com",
        projectId: "vehicle-impound",
        storageBucket: "vehicle-impound.firebasestorage.app",
        messagingSenderId: "69239563292",
        appId: "1:69239563292:web:281912e8a38301c0feabd9",
      };

      // Initialize Firebase
      let db, auth;
      let currentUser = null;
      let currentVehicleId = null;
      let allVehicles = [];
      let filteredVehicles = [];
      let allUsers = new Map();
      let allViolations = new Map();
      let vehicleReleases = new Map();
      let vehiclePayments = new Map();

      // Pagination variables
      let currentPage = 1;
      const itemsPerPage = 8;

      // Pagination elements
      const pagination = document.getElementById("pagination");
      const prevPageBtn = document.getElementById("prevPage");
      const nextPageBtn = document.getElementById("nextPage");
      const pageInfo = document.getElementById("pageInfo");

      console.log("Initializing Firebase...");
      try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        auth = firebase.auth();
        console.log("✅ Firebase initialized successfully");

        // START INITIALIZATION AFTER DOM LOAD (See below)
      } catch (error) {
        console.error("❌ Firebase initialization error:", error);
        showErrorMessage("Firebase initialization failed: " + error.message);
      }

      // Initialize the application
      document.addEventListener("DOMContentLoaded", function () {
        console.log("DOM Content Loaded");

        // 1. FETCH THE SIDEBAR
        fetch("sidebar.html")
          .then((response) => {
            if (!response.ok) throw new Error("Sidebar not found");
            return response.text();
          })
          .then((data) => {
            // Inject the HTML
            document.getElementById("sidebar-container").innerHTML = data;

            // Highlight the "Impound Records" link
            highlightActiveLink();
          })
          .catch((error) => console.error("Error loading sidebar:", error));

        // 2. INITIALIZE APP
        initializeApp();

        // 3. Set up pagination event listeners
        prevPageBtn.addEventListener("click", () => changePage(-1));
        nextPageBtn.addEventListener("click", () => changePage(1));
      });

      // --- SIDEBAR HELPER FUNCTION ---
      function highlightActiveLink() {
        // Current Page: impound-records.html
        const page = "impound-records.html";

        const links = document.querySelectorAll(".sidebar-menu a");

        links.forEach((link) => {
          const href = link.getAttribute("href");
          if (href === page) {
            link.classList.add("active");
          } else {
            link.classList.remove("active");
          }
        });
      }

      async function initializeApp() {
        try {
          // Note: Sidebar listener removed as it is handled by the fetched component

          auth.onAuthStateChanged(async (user) => {
            if (user) {
              currentUser = user;
              console.log("User authenticated:", user.email);
              await loadUserData(user.uid);
              setupEventListeners();
              await loadUsersCache();
              await loadViolationsCache();
              await loadAllData();
            } else {
              console.log("No user authenticated, redirecting to login...");
              window.location.href = "../index.html";
            }
          });
        } catch (error) {
          console.error("Error initializing app:", error);
          showError("Error initializing application: " + error.message);
        }
      }

      async function loadUsersCache() {
        try {
          const usersSnapshot = await db.collection("users").get();
          allUsers.clear();
          usersSnapshot.forEach((doc) => {
            allUsers.set(doc.id, doc.data());
          });
          console.log(`✅ Loaded ${allUsers.size} users into cache`);
        } catch (error) {
          console.error("Error loading users cache:", error);
        }
      }

      async function loadViolationsCache() {
        try {
          const violationsSnapshot = await db.collection("violations").get();
          allViolations.clear();
          violationsSnapshot.forEach((doc) => {
            allViolations.set(doc.id, doc.data());
          });
          console.log(`✅ Loaded ${allViolations.size} violations into cache`);
        } catch (error) {
          console.error("Error loading violations cache:", error);
        }
      }

      async function loadUserData(userId) {
        try {
          let userData;

          if (allUsers.has(userId)) {
            userData = allUsers.get(userId);
          } else {
            const userDoc = await db.collection("users").doc(userId).get();
            if (userDoc.exists) {
              userData = userDoc.data();
              allUsers.set(userId, userData);
            }
          }

          if (userData) {
            document.getElementById("userDisplayName").textContent =
              userData.fullName || "Admin User";
            document.getElementById("userRole").textContent =
              formatRole(userData.role) || "System Administrator";

            if (userData.fullName) {
              const initials = getInitials(userData.fullName);
              document.getElementById("avatarIcon").parentElement.innerHTML =
                initials;
            }
          }
        } catch (error) {
          console.error("Error loading user data:", error);
        }
      }

      function toggleLogoutDropdown() {
        const dropdown = document.getElementById("logoutDropdown");
        dropdown.style.display =
          dropdown.style.display === "block" ? "none" : "block";
      }

      document.addEventListener("click", function (event) {
        const dropdown = document.getElementById("logoutDropdown");
        const userAvatar = document.getElementById("userAvatar");

        if (
          userAvatar &&
          !userAvatar.contains(event.target) &&
          dropdown &&
          !dropdown.contains(event.target)
        ) {
          dropdown.style.display = "none";
        }
      });

      function viewProfile() {
        alert("Profile view functionality would go here");
        document.getElementById("logoutDropdown").style.display = "none";
      }

      function changePassword() {
        alert("Change password functionality would go here");
        document.getElementById("logoutDropdown").style.display = "none";
      }

      async function logout() {
        if (confirm("Are you sure you want to logout?")) {
          try {
            await auth.signOut();
            window.location.href = "../index.html";
          } catch (error) {
            console.error("Error during logout:", error);
          }
        }
      }

      function getInitials(fullName) {
        return fullName
          .split(" ")
          .map((name) => name[0])
          .join("")
          .toUpperCase()
          .substring(0, 2);
      }

      function formatRole(role) {
        const roleMap = {
          admin: "Administrator",
          officer: "Impounding Officer",
          cashier: "Cashier",
          releasing: "Releasing Officer",
        };
        return roleMap[role] || role;
      }

      function setupEventListeners() {
        console.log("Setting up event listeners");

        const today = new Date();
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(today.getDate() - 30);

        document.getElementById("dateFrom").value = thirtyDaysAgo
          .toISOString()
          .split("T")[0];
        document.getElementById("dateTo").value = today
          .toISOString()
          .split("T")[0];

        document
          .getElementById("applyFilter")
          .addEventListener("click", applyFilters);
        document
          .getElementById("clearFilter")
          .addEventListener("click", clearFilters);
        document
          .getElementById("refreshBtn")
          .addEventListener("click", refreshData);
        document
          .getElementById("exportBtn")
          .addEventListener("click", exportData);
        document
          .getElementById("searchFilter")
          .addEventListener("input", debounce(applyFilters, 300));
        document
          .getElementById("searchFilter")
          .setAttribute("placeholder", "Plate number or reference...");

        // Close modal when clicking outside
        window.addEventListener("click", function (event) {
          const modal = document.getElementById("vehicleDetailsModal");
          if (event.target === modal) {
            closeVehicleModal();
          }
        });
      }

      async function loadAllData() {
        showLoading();
        console.log("Loading impounded vehicles from Firestore...");

        try {
          const vehiclesSnapshot = await db
            .collection("impoundedVehicles")
            .orderBy("impoundDate", "desc")
            .get();

          console.log(
            `✅ Successfully retrieved ${vehiclesSnapshot.size} vehicles`
          );

          if (vehiclesSnapshot.size === 0) {
            showNoDataMessage();
            return;
          }

          allVehicles = [];
          vehicleReleases.clear();
          vehiclePayments.clear();

          const vehiclePromises = [];

          vehiclesSnapshot.forEach((doc) => {
            vehiclePromises.push(processVehicleData(doc));
          });

          const processedVehicles = await Promise.all(vehiclePromises);
          allVehicles = processedVehicles.filter((v) => v !== null);

          filteredVehicles = [...allVehicles];
          currentPage = 1; // Reset to first page
          renderVehiclesTable();
        } catch (error) {
          console.error("❌ Error loading data:", error);
          showErrorMessage(
            "Error loading impounded vehicles: " + error.message
          );
        }
      }

      function renderVehiclesTable() {
        const tbody = document.getElementById("impoundedVehiclesTableBody");

        if (filteredVehicles.length === 0) {
          tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; padding: 20px; color: #666;">
                    No vehicles found matching your criteria.
                </td>
            </tr>
          `;
          pagination.style.display = "none";
          return;
        }

        // Calculate pagination
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageVehicles = filteredVehicles.slice(start, end);
        const totalPages = Math.ceil(filteredVehicles.length / itemsPerPage);

        let tableHTML = "";

        pageVehicles.forEach((vehicle) => {
          const fineAmount = vehicle.totalFine || 0;
          const dateImpounded = formatDate(vehicle.impoundDate);
          const status = getVehicleStatus(vehicle);
          const statusClass = getStatusClass(status.status);
          const statusText = status.text;

          // Use referenceNumber field first, then readableId as fallback
          const referenceNo =
            vehicle.referenceNumber || vehicle.readableId || "N/A";

          tableHTML += `
            <tr>
                <td><strong>${referenceNo}</strong></td>
                <td><strong>${vehicle.plateNumber || "N/A"}</strong></td>
                <td>${vehicle.vehicleType || "N/A"}</td>
                <td>₱${fineAmount.toLocaleString()}</td>
                <td>${dateImpounded}</td>
                <td><span class="status ${statusClass}">${statusText}</span></td>
                <td class="action-cell">
                    <div class="action-icon-btn action-view" onclick="viewVehicle('${
                      vehicle.id
                    }')" title="View Details">
                        <i class="fas fa-eye"></i>
                    </div>
                </td>
            </tr>
          `;
        });

        tbody.innerHTML = tableHTML;

        // Update pagination
        updatePagination(totalPages);

        console.log(
          `✅ Table populated with ${pageVehicles.length} vehicles (Page ${currentPage}/${totalPages})`
        );
      }

      function updatePagination(totalPages) {
        if (totalPages > 1) {
          pagination.style.display = "flex";
          pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
          prevPageBtn.disabled = currentPage === 1;
          nextPageBtn.disabled = currentPage === totalPages;
        } else {
          pagination.style.display = "none";
        }
      }

      function changePage(dir) {
        const totalPages = Math.ceil(filteredVehicles.length / itemsPerPage);
        currentPage += dir;
        if (currentPage < 1) currentPage = 1;
        if (currentPage > totalPages) currentPage = totalPages;
        renderVehiclesTable();
        // Scroll to top of table
        document
          .querySelector(".data-table")
          .scrollIntoView({ behavior: "smooth" });
      }

      async function processVehicleData(doc) {
        try {
          const vehicleData = doc.data();

          // Generate readable ID (will use referenceNumber field first)
          const readableId = generateReadableId(vehicleData);

          // Get impound officer details
          let impoundOfficerName = vehicleData.impoundingOfficerName || "N/A";
          let impoundOfficerDetails = {};
          if (
            vehicleData.impoundingOfficerId &&
            allUsers.has(vehicleData.impoundingOfficerId)
          ) {
            const officerData = allUsers.get(vehicleData.impoundingOfficerId);
            impoundOfficerDetails = officerData;
            impoundOfficerName = officerData.fullName || impoundOfficerName;
          }

          // Get violation details - FIXED FUNCTION
          const violations = await getVehicleViolations(vehicleData);

          // Get release status
          const releaseStatus = await getVehicleReleaseStatus(doc.id);

          // Get payment status
          const paymentStatus = await getVehiclePaymentStatus(doc.id);

          // Calculate total fine
          const totalFine = calculateTotalFine(vehicleData, violations);

          // Get penalty points
          const penaltyPoints =
            violations.reduce(
              (total, violation) => total + (violation.penaltyPoints || 0),
              0
            ) ||
            vehicleData.penaltyPoints ||
            0;

          return {
            id: doc.id,
            ...vehicleData,
            referenceNumber:
              vehicleData.referenceNumber || vehicleData.refNumber || null,
            readableId: readableId,
            impoundOfficerName: impoundOfficerName,
            impoundOfficerDetails: impoundOfficerDetails,
            violations: violations,
            totalFine: totalFine,
            penaltyPoints: penaltyPoints,
            releaseStatus: releaseStatus.status,
            releaseInfo: releaseStatus.data,
            paymentStatus: paymentStatus.status,
            paymentInfo: paymentStatus.data,
            totalPaid: paymentStatus.totalPaid || 0,
            balance: totalFine - (paymentStatus.totalPaid || 0),
          };
        } catch (error) {
          console.error(`Error processing vehicle ${doc.id}:`, error);
          return null;
        }
      }

      function generateReadableId(vehicleData) {
        // Priority 1: Use referenceNumber field if it exists
        if (vehicleData.referenceNumber) {
          return vehicleData.referenceNumber;
        }

        // Priority 2: Use refNumber field if it exists (backward compatibility)
        if (vehicleData.refNumber) {
          return vehicleData.refNumber;
        }

        // Create from plate number and date as fallback
        const plateNumber = vehicleData.plateNumber || "";
        const impoundDate =
          vehicleData.impoundDate || new Date().toISOString().split("T")[0];

        if (plateNumber && impoundDate) {
          const date = new Date(impoundDate);
          const year = date.getFullYear().toString().substr(-2);
          const month = String(date.getMonth() + 1).padStart(2, "0");
          const day = String(date.getDate()).padStart(2, "0");

          // Format: IMP-YYMMDD-XXX where XXX is last 3 chars of plate number
          const plateSuffix = plateNumber.slice(-3).toUpperCase();
          return `IMP-${year}${month}${day}-${plateSuffix}`;
        }

        // Fallback: use vehicleId or generate random
        return vehicleData.vehicleId
          ? `IMP-${vehicleData.vehicleId.substring(0, 8).toUpperCase()}`
          : `IMP-${Date.now().toString().slice(-6)}`;
      }

      async function getVehicleViolations(vehicleData) {
        try {
          const violationRefs = vehicleData.violationIds || [];
          const violationCode = vehicleData.violationCode || "";
          const violationDescription = vehicleData.violationDescription || "";
          const fineAmount = vehicleData.fineAmount || 0;
          const penaltyPoints = vehicleData.penaltyPoints || 0;

          console.log("Processing violations for vehicle:", {
            violationRefs: violationRefs,
            violationCode: violationCode,
            violationDescription: violationDescription,
          });

          let violations = [];

          // If we have violation references (Firestore DocumentReferences or string IDs)
          if (violationRefs.length > 0) {
            console.log(`Found ${violationRefs.length} violation references`);

            // Process each violation reference
            for (const violationRef of violationRefs) {
              try {
                let violationId = null;
                let violationDoc = null;

                // Check if it's a Firestore DocumentReference
                if (violationRef && typeof violationRef === "object") {
                  // It might be a DocumentReference
                  if (violationRef.path && violationRef.get) {
                    // It's a DocumentReference
                    console.log(
                      "Processing DocumentReference:",
                      violationRef.path
                    );
                    violationDoc = await violationRef.get();
                    violationId = violationRef.id;
                  } else if (violationRef.id) {
                    // It's an object with an id property
                    violationId = violationRef.id;
                    violationDoc = await db
                      .collection("violations")
                      .doc(violationId)
                      .get();
                  }
                } else if (typeof violationRef === "string") {
                  // It's a string ID
                  console.log("Processing string ID:", violationRef);
                  violationId = violationRef;
                  violationDoc = await db
                    .collection("violations")
                    .doc(violationRef)
                    .get();
                }

                if (violationDoc && violationDoc.exists) {
                  const violation = violationDoc.data();
                  console.log("Found violation document:", violation);

                  // Add to cache
                  allViolations.set(violationId, violation);

                  violations.push({
                    id: violationId,
                    code: violation.violationCode || violation.code || "N/A",
                    description:
                      violation.violationDescription ||
                      violation.description ||
                      violationDescription ||
                      "Traffic Violation",
                    fineAmount: violation.fineAmount || violation.amount || 0,
                    penaltyPoints: violation.penaltyPoints || 0,
                  });
                } else {
                  console.warn(
                    "Violation document not found for reference:",
                    violationRef
                  );
                }
              } catch (error) {
                console.error(
                  "Error processing violation reference:",
                  violationRef,
                  error
                );
              }
            }
          }

          // If we still have no violations, check the violationCode field (fallback)
          if (violations.length === 0 && violationCode) {
            console.log("Using violationCode as fallback:", violationCode);
            const codes = violationCode
              .split(",")
              .map((code) => code.trim())
              .filter((code) => code !== "");

            if (codes.length > 0) {
              violations = codes.map((code) => ({
                code: code,
                description: violationDescription || `Violation ${code}`,
                fineAmount: fineAmount / codes.length,
                penaltyPoints: penaltyPoints / codes.length,
              }));
            }
          }

          // If still no violations, create a default one
          if (violations.length === 0) {
            console.log("Creating default violation");
            const violationCodes = violationCode
              ? violationCode
                  .split(",")
                  .map((c) => c.trim())
                  .filter((c) => c)
              : ["N/A"];

            violations = violationCodes.map((code) => ({
              code: code,
              description: violationDescription || "Traffic Violation",
              fineAmount: fineAmount / violationCodes.length,
              penaltyPoints: penaltyPoints / violationCodes.length,
            }));
          }

          console.log("Final violations array:", violations);
          return violations;
        } catch (error) {
          console.error("Error getting vehicle violations:", error);
          // Return a default violation
          return [
            {
              code: vehicleData.violationCode || "N/A",
              description:
                vehicleData.violationDescription || "Traffic Violation",
              fineAmount: vehicleData.fineAmount || 0,
              penaltyPoints: vehicleData.penaltyPoints || 0,
            },
          ];
        }
      }

      async function getVehicleReleaseStatus(vehicleId) {
        try {
          if (vehicleReleases.has(vehicleId)) {
            return vehicleReleases.get(vehicleId);
          }

          const releasesSnapshot = await db
            .collection("releases")
            .where("vehicleId", "==", vehicleId)
            .orderBy("releaseDate", "desc")
            .limit(1)
            .get();

          let releaseData = null;
          let status = "not_released";

          if (!releasesSnapshot.empty) {
            const releaseDoc = releasesSnapshot.docs[0];
            releaseData = releaseDoc.data();
            status = releaseData.status || "released";
            vehicleReleases.set(vehicleId, {
              status: status,
              data: releaseData,
            });
          } else {
            vehicleReleases.set(vehicleId, { status: status, data: null });
          }

          return { status: status, data: releaseData };
        } catch (error) {
          console.error(
            `Error getting release status for ${vehicleId}:`,
            error
          );
          return { status: "not_released", data: null };
        }
      }

      async function getVehiclePaymentStatus(vehicleId) {
        try {
          if (vehiclePayments.has(vehicleId)) {
            return vehiclePayments.get(vehicleId);
          }

          const paymentsSnapshot = await db
            .collection("payments")
            .where("vehicleId", "==", vehicleId)
            .orderBy("paymentDate", "desc")
            .get();

          let totalPaid = 0;
          let paymentRecords = [];

          paymentsSnapshot.forEach((doc) => {
            const paymentData = doc.data();
            totalPaid += paymentData.amount || 0;
            paymentRecords.push(paymentData);
          });

          let status = "unpaid";
          if (totalPaid > 0) {
            status = paymentsSnapshot.empty
              ? "unpaid"
              : paymentsSnapshot.docs[0].data().status || "partial";
          }

          const result = {
            status: status,
            totalPaid: totalPaid,
            records: paymentRecords,
            count: paymentsSnapshot.size,
          };

          vehiclePayments.set(vehicleId, result);
          return result;
        } catch (error) {
          console.error(
            `Error getting payment status for ${vehicleId}:`,
            error
          );
          return { status: "unpaid", totalPaid: 0, records: [], count: 0 };
        }
      }

      function calculateTotalFine(vehicleData, violations) {
        if (violations && violations.length > 0) {
          return violations.reduce(
            (total, violation) => total + (violation.fineAmount || 0),
            0
          );
        }
        return vehicleData.fineAmount || 0;
      }

      function getVehicleStatus(vehicle) {
        // Check release status first
        if (vehicle.releaseStatus === "released") {
          return { status: "released", text: "Released" };
        }

        // Check payment status
        if (vehicle.paymentStatus === "paid") {
          return { status: "paid", text: "Paid" };
        }

        if (vehicle.paymentStatus === "partial") {
          return { status: "partial", text: "Partial Payment" };
        }

        // Check vehicle status field
        if (vehicle.status === "approved") {
          return { status: "approved", text: "Approved for Release" };
        }

        // Default to impounded
        return { status: "impounded", text: "Impounded" };
      }

      function getStatusClass(status) {
        const statusMap = {
          impounded: "status-impounded",
          partial: "status-pending",
          paid: "status-paid",
          approved: "status-approved",
          released: "status-released",
          unpaid: "status-pending",
        };
        return statusMap[status] || "status-impounded";
      }

      function formatDate(dateValue) {
        if (!dateValue) return "N/A";

        try {
          let date;
          if (typeof dateValue === "string") {
            date = new Date(dateValue);
          } else if (dateValue.toDate) {
            date = dateValue.toDate();
          } else {
            date = new Date(dateValue);
          }

          return date.toLocaleDateString("en-US", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
          });
        } catch (error) {
          console.error("Error formatting date:", error);
          return "N/A";
        }
      }

      async function viewVehicle(vehicleId) {
        try {
          console.log("Viewing vehicle:", vehicleId);
          currentVehicleId = vehicleId;

          const vehicleDoc = await db
            .collection("impoundedVehicles")
            .doc(vehicleId)
            .get();

          if (!vehicleDoc.exists) {
            showError("Vehicle not found!");
            return;
          }

          const vehicleData = vehicleDoc.data();
          const vehicle =
            allVehicles.find((v) => v.id === vehicleId) ||
            (await processVehicleData(vehicleDoc));

          // Update modal with all information
          updateVehicleModal(vehicle);
        } catch (error) {
          console.error("Error loading vehicle details:", error);
          showError("Error loading vehicle details: " + error.message);
        }
      }

      function updateVehicleModal(vehicle) {
        if (!vehicle) return;

        // Create HTML for violations
        const violationsHTML =
          vehicle.violations && vehicle.violations.length > 0
            ? vehicle.violations
                .map(
                  (violation) => `
                <div class="violation-item">
                    <div class="violation-code">${violation.code}</div>
                    <div class="violation-details">
                        <div class="violation-description">${
                          violation.description
                        }</div>
                        <div class="violation-penalty">
                            <span class="fine">₱${(
                              violation.fineAmount || 0
                            ).toLocaleString()}</span>
                            <span class="points">${
                              violation.penaltyPoints || 0
                            } points</span>
                        </div>
                    </div>
                </div>
            `
                )
                .join("")
            : '<div class="no-violations">No violations recorded</div>';

        // Create HTML for payment history
        const paymentsHTML =
          vehicle.paymentInfo &&
          vehicle.paymentInfo.records &&
          vehicle.paymentInfo.records.length > 0
            ? vehicle.paymentInfo.records
                .map(
                  (payment) => `
                <div class="payment-item">
                    <div class="payment-date">${formatDate(
                      payment.paymentDate
                    )}</div>
                    <div class="payment-details">
                        <div class="payment-amount">₱${(
                          payment.amount || 0
                        ).toLocaleString()}</div>
                        <div class="payment-method">${
                          payment.paymentMethod || "Cash"
                        } • ${payment.receiptNumber || "No receipt"}</div>
                    </div>
                </div>
            `
                )
                .join("")
            : '<div class="no-payments">No payment records</div>';

        // Create HTML for release history
        const releasesHTML =
          vehicle.releaseInfo && vehicle.releaseInfo.data
            ? `
                <div class="release-item">
                    <div class="release-date">${formatDate(
                      vehicle.releaseInfo.data.releaseDate
                    )}</div>
                    <div class="release-details">
                        <div class="release-officer">${
                          vehicle.releaseInfo.data.releasingOfficer || "N/A"
                        }</div>
                        <div class="release-notes">${
                          vehicle.releaseInfo.data.notes || "No notes"
                        }</div>
                    </div>
                </div>
            `
            : '<div class="no-releases">No release records</div>';

        // Use referenceNumber field first, then readableId as fallback
        const referenceNo =
          vehicle.referenceNumber || vehicle.readableId || "N/A";

        // Update modal content
        document.getElementById("vehicleDetailsModal").innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Vehicle Details</h3>
                    <span class="close-modal" onclick="closeVehicleModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="vehicle-details-container">
                        
                        <div class="summary-card">
                            <div class="summary-header">
                                <h4><i class="fas fa-car"></i> Vehicle Summary</h4>
                                <span class="status ${getStatusClass(
                                  getVehicleStatus(vehicle).status
                                )}">
                                    ${getVehicleStatus(vehicle).text}
                                </span>
                            </div>
                            <div class="summary-grid">
                                <div class="summary-item">
                                    <div class="summary-label">Reference No.</div>
                                    <div class="summary-value">${referenceNo}</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-label">Plate Number</div>
                                    <div class="summary-value">${
                                      vehicle.plateNumber || "N/A"
                                    }</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-label">Vehicle Type</div>
                                    <div class="summary-value">${
                                      vehicle.vehicleType || "N/A"
                                    }</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-label">Total Fine</div>
                                    <div class="summary-value amount">₱${vehicle.totalFine.toLocaleString()}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="two-column-layout">
                            
                            <div class="column">
                                <div class="info-section">
                                    <h4><i class="fas fa-info-circle"></i> Vehicle Information</h4>
                                    <div class="info-grid">
                                        <div class="info-item">
                                            <div class="info-label">Model</div>
                                            <div class="info-value">${
                                              vehicle.vehicleModel || "N/A"
                                            }</div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-label">Color</div>
                                            <div class="info-value">${
                                              vehicle.vehicleColor || "N/A"
                                            }</div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-label">Slot Number</div>
                                            <div class="info-value">${
                                              vehicle.slotNumber || "N/A"
                                            }</div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-label">Condition Notes</div>
                                            <div class="info-value">${
                                              vehicle.conditionNotes ||
                                              "No notes"
                                            }</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="info-section">
                                    <h4><i class="fas fa-user"></i> Owner Information</h4>
                                    <div class="info-grid">
                                        <div class="info-item">
                                            <div class="info-label">Owner Name</div>
                                            <div class="info-value">${
                                              vehicle.ownerName || "N/A"
                                            }</div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-label">Contact</div>
                                            <div class="info-value">${
                                              vehicle.ownerContact || "N/A"
                                            }</div>
                                        </div>
                                        <div class="info-item full-width">
                                            <div class="info-label">Address</div>
                                            <div class="info-value">${
                                              vehicle.ownerAddress || "N/A"
                                            }</div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-label">Email</div>
                                            <div class="info-value">${
                                              vehicle.ownerEmail || "N/A"
                                            }</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="column">
                                <div class="info-section">
                                    <h4><i class="fas fa-calendar-alt"></i> Impound Details</h4>
                                    <div class="info-grid">
                                        <div class="info-item">
                                            <div class="info-label">Impound Date</div>
                                            <div class="info-value">${formatDate(
                                              vehicle.impoundDate
                                            )}</div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-label">Impound Time</div>
                                            <div class="info-value">${
                                              vehicle.impoundTime || "N/A"
                                            }</div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-label">Impound Officer</div>
                                            <div class="info-value">${
                                              vehicle.impoundOfficerName ||
                                              "N/A"
                                            }</div>
                                        </div>
                                        <div class="info-item full-width">
                                            <div class="info-label">Towing Location</div>
                                            <div class="info-value">${
                                              vehicle.towingLocation || "N/A"
                                            }</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="info-section">
                                    <h4><i class="fas fa-money-bill-wave"></i> Financial Summary</h4>
                                    <div class="info-grid">
                                        <div class="info-item">
                                            <div class="info-label">Total Fine</div>
                                            <div class="info-value amount">₱${vehicle.totalFine.toLocaleString()}</div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-label">Amount Paid</div>
                                            <div class="info-value amount paid">₱${vehicle.totalPaid.toLocaleString()}</div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-label">Balance</div>
                                            <div class="info-value amount ${
                                              vehicle.balance > 0
                                                ? "unpaid"
                                                : "paid"
                                            }">
                                                ₱${vehicle.balance.toLocaleString()}
                                            </div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-label">Payment Status</div>
                                            <div class="info-value">
                                                <span class="status ${
                                                  vehicle.paymentStatus ===
                                                  "paid"
                                                    ? "status-paid"
                                                    : "status-pending"
                                                }">
                                                    ${
                                                      vehicle.paymentStatus ===
                                                      "paid"
                                                        ? "Paid"
                                                        : vehicle.paymentStatus ===
                                                          "partial"
                                                        ? "Partial"
                                                        : "Unpaid"
                                                    }
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="info-section full-width">
                            <h4><i class="fas fa-exclamation-triangle"></i> Violations (${
                              vehicle.violations ? vehicle.violations.length : 0
                            })</h4>
                            <div class="violations-list">
                                ${violationsHTML}
                            </div>
                        </div>
                        
                        <div class="two-column-layout">
                            <div class="column">
                                <div class="info-section">
                                    <h4><i class="fas fa-history"></i> Payment History (${
                                      vehicle.paymentInfo
                                        ? vehicle.paymentInfo.count
                                        : 0
                                    })</h4>
                                    <div class="payment-list">
                                        ${paymentsHTML}
                                    </div>
                                </div>
                            </div>
                            <div class="column">
                                <div class="info-section">
                                    <h4><i class="fas fa-check-circle"></i> Release Status</h4>
                                    <div class="release-list">
                                        ${releasesHTML}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        ${
                          vehicle.qrCodeImage
                            ? `
                            <div class="info-section full-width">
                                <h4><i class="fas fa-qrcode"></i> Vehicle QR Code</h4>
                                <div style="text-align: center; padding: 10px;">
                                    <img src="${vehicle.qrCodeImage}" alt="Vehicle QR Code" style="max-width: 200px; height: auto;">
                                </div>
                            </div>
                        `
                            : ""
                        }
                        
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" onclick="closeVehicleModal()">Close</button>
                    <button type="button" class="btn btn-primary" onclick="printVehicleDetails('${
                      vehicle.id
                    }')">
                        <i class="fas fa-print"></i> Print
                    </button>
                    ${
                      vehicle.balance <= 0 &&
                      vehicle.releaseStatus !== "released"
                        ? `
                        <button type="button" class="btn btn-success" onclick="approveForRelease('${vehicle.id}')">
                            <i class="fas fa-check"></i> Approve Release
                        </button>
                    `
                        : ""
                    }
                </div>
            </div>
        `;

        // Show modal
        document.getElementById("vehicleDetailsModal").style.display = "block";
      }

      function closeVehicleModal() {
        document.getElementById("vehicleDetailsModal").style.display = "none";
        currentVehicleId = null;
      }

      function printVehicleDetails(vehicleId) {
        const modalContent = document
          .querySelector(".modal-content")
          .cloneNode(true);

        // Remove action buttons for print
        const actions = modalContent.querySelector(".modal-actions");
        if (actions) actions.remove();

        // Open print window
        const printWindow = window.open("", "", "width=900,height=600");
        printWindow.document.write(`
            <html>
                <head>
                    <title>Vehicle Details - ${vehicleId}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        .print-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                        .print-section { margin-bottom: 15px; }
                        .print-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 10px; }
                        .print-label { font-weight: bold; color: #666; }
                        .print-value { margin-bottom: 5px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f5f5f5; }
                    </style>
                </head>
                <body>
                    ${modalContent.innerHTML}
                    <script>
                        window.onload = function() { window.print(); }
                    <\/script>
                </body>
            </html>
        `);
        printWindow.document.close();
      }

      function approveForRelease(vehicleId) {
        if (
          confirm("Are you sure you want to approve this vehicle for release?")
        ) {
          // Update vehicle status to approved
          db.collection("impoundedVehicles")
            .doc(vehicleId)
            .update({
              status: "approved",
              updatedAt: new Date().toISOString(),
            })
            .then(() => {
              alert("Vehicle approved for release!");
              closeVehicleModal();
              refreshData();
            })
            .catch((error) => {
              console.error("Error approving vehicle:", error);
              alert("Error approving vehicle: " + error.message);
            });
        }
      }

      function applyFilters() {
        let tempFiltered = [...allVehicles];

        const statusFilter = document.getElementById("statusFilter").value;
        const dateFrom = document.getElementById("dateFrom").value;
        const dateTo = document.getElementById("dateTo").value;
        const searchText = document
          .getElementById("searchFilter")
          .value.toLowerCase();

        if (statusFilter) {
          tempFiltered = tempFiltered.filter((vehicle) => {
            const status = getVehicleStatus(vehicle);
            return status.status === statusFilter;
          });
        }

        if (dateFrom || dateTo) {
          const fromDate = dateFrom ? new Date(dateFrom) : null;
          const toDate = dateTo ? new Date(dateTo + "T23:59:59") : null;

          tempFiltered = tempFiltered.filter((vehicle) => {
            const impoundDate = vehicle.impoundDate
              ? new Date(vehicle.impoundDate)
              : null;
            if (!impoundDate) return false;

            if (fromDate && impoundDate < fromDate) return false;
            if (toDate && impoundDate > toDate) return false;
            return true;
          });
        }

        if (searchText) {
          tempFiltered = tempFiltered.filter((vehicle) => {
            return (
              (vehicle.plateNumber &&
                vehicle.plateNumber.toLowerCase().includes(searchText)) ||
              (vehicle.referenceNumber && // Search by referenceNumber field
                vehicle.referenceNumber.toLowerCase().includes(searchText)) ||
              (vehicle.readableId &&
                vehicle.readableId.toLowerCase().includes(searchText)) ||
              (vehicle.vehicleId &&
                vehicle.vehicleId.toLowerCase().includes(searchText))
            );
          });
        }

        filteredVehicles = tempFiltered;
        currentPage = 1; // Reset to first page when applying filters
        renderVehiclesTable();

        console.log(
          `Applied filters: ${filteredVehicles.length} vehicles match criteria`
        );
      }

      function clearFilters() {
        document.getElementById("statusFilter").value = "";
        document.getElementById("dateFrom").value = "";
        document.getElementById("dateTo").value = "";
        document.getElementById("searchFilter").value = "";

        filteredVehicles = [...allVehicles];
        currentPage = 1; // Reset to first page when clearing filters
        renderVehiclesTable();
      }

      function refreshData() {
        loadAllData();
      }

      function exportData() {
        if (filteredVehicles.length === 0) {
          alert("No data to export");
          return;
        }

        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent +=
          "Reference No,Plate Number,Vehicle Type,Total Fine,Date Impounded,Status,Impound Officer,Slot Number,Towing Location\n";

        filteredVehicles.forEach((vehicle) => {
          const dateImpounded = formatDate(vehicle.impoundDate);
          const status = getVehicleStatus(vehicle);

          // Use referenceNumber field first, then readableId as fallback
          const referenceNo =
            vehicle.referenceNumber || vehicle.readableId || "";

          const row = [
            referenceNo,
            `"${vehicle.plateNumber || ""}"`,
            `"${vehicle.vehicleType || ""}"`,
            vehicle.totalFine || 0,
            dateImpounded,
            status.text,
            `"${vehicle.impoundOfficerName || ""}"`,
            vehicle.slotNumber || "",
            vehicle.towingLocation || "",
          ].join(",");
          csvContent += row + "\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute(
          "download",
          `impound_records_${new Date().toISOString().split("T")[0]}.csv`
        );
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function showLoading() {
        const tbody = document.getElementById("impoundedVehiclesTableBody");
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; padding: 20px;">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i> Loading impounded vehicles...
                    </div>
                </td>
            </tr>
        `;
        pagination.style.display = "none";
      }

      function showNoDataMessage() {
        const tbody = document.getElementById("impoundedVehiclesTableBody");
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; padding: 20px; color: #666;">
                    <i class="fas fa-info-circle"></i> No impounded vehicles found in the database.
                </td>
            </tr>
        `;
        pagination.style.display = "none";
      }

      function showErrorMessage(message) {
        const tbody = document.getElementById("impoundedVehiclesTableBody");
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; padding: 20px; color: #dc3545;">
                    <i class="fas fa-exclamation-triangle"></i> ${message}
                </td>
            </tr>
        `;
        pagination.style.display = "none";
      }

      function showError(message) {
        alert("Error: " + message);
      }

      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }
    </script>
  </body>
</html>
