<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Add Vehicle - VIMS</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <style>
      :root {
        /* VIMS Modern Palette */
        --primary: #2563eb;
        --primary-soft: #dbeafe;
        --primary-dark: #1e40af;
        --sidebar-bg: #0f172a;
        --bg-body: #f1f5f9;
        --bg-card: #ffffff;
        --text-main: #1e293b;
        --text-muted: #64748b;
        --border: #e2e8f0;
        --danger: #ef4444;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --radius: 12px;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Inter", "Segoe UI", Roboto, sans-serif;
      }
      body {
        background-color: var(--bg-body);
        display: flex;
        min-height: 100vh;
        color: var(--text-main);
        overflow-x: hidden;
      }

      /* Animation */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Sidebar */
      .sidebar {
        width: 260px;
        background: var(--sidebar-bg);
        color: white;
        height: 100vh;
        position: fixed;
        left: 0;
        top: 0;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        transition: 0.3s;
      }
      .sidebar-header {
        padding: 30px 24px;
        display: flex;
        align-items: center;
        gap: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        flex-shrink: 0;
      }
      .logo svg {
        width: 40px;
        height: 40px;
      }
      .sidebar-header h2 {
        font-size: 20px;
        font-weight: 700;
        letter-spacing: 0.5px;
      }
      .sidebar-menu {
        padding: 20px 15px;
        flex: 1;
        overflow-y: auto;
      }
      .sidebar-menu ul {
        list-style: none;
      }
      .sidebar-menu li {
        margin-bottom: 5px;
      }
      .sidebar-menu a {
        display: flex;
        align-items: center;
        padding: 14px 20px;
        color: #94a3b8;
        text-decoration: none;
        transition: 0.2s;
        border-radius: 8px;
        font-weight: 500;
        font-size: 14px;
      }
      .sidebar-menu a:hover,
      .sidebar-menu a.active {
        background-color: rgba(255, 255, 255, 0.1);
        color: white;
      }
      .sidebar-menu a.active {
        background: var(--primary);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
      }
      .sidebar-menu i {
        margin-right: 12px;
        width: 20px;
        text-align: center;
        font-size: 16px;
      }
      /* FIXED: Logout at very bottom */
      .sidebar-logout {
        padding: 20px;
        background: rgba(0, 0, 0, 0.2);
        border-top: 1px solid rgba(255, 255, 255, 0.08);
        /* No margin-top needed because sidebar-content is flex column */
      }
      .sidebar-logout ul {
        list-style: none;
      }
      .sidebar-logout a {
        display: flex;
        align-items: center;
        padding: 12px 15px;
        color: #fca5a5;
        text-decoration: none;
        transition: 0.3s;
        border-radius: 8px;
        font-weight: 500;
      }
      .sidebar-logout a:hover {
        background-color: rgba(239, 68, 68, 0.15);
        color: #f87171;
      }
      .sidebar-logout i {
        margin-right: 12px;
        width: 20px;
        text-align: center;
      }

      /* Main Content */
      .main-content {
        flex: 1;
        margin-left: 260px;
        padding: 30px 40px;
        padding-bottom: 80px;
      }
      .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
      }
      .page-title h1 {
        font-size: 26px;
        color: var(--text-main);
        font-weight: 800;
        letter-spacing: -0.5px;
        margin-bottom: 5px;
      }
      .page-title p {
        color: var(--text-muted);
        font-size: 14px;
      }

      /* User Menu */
      .user-menu {
        display: flex;
        align-items: center;
        position: relative;
        padding: 6px 8px 6px 16px;
        border-radius: 50px;
        background: white;
        border: 1px solid var(--border);
        box-shadow: var(--shadow-sm);
        cursor: pointer;
      }
      .user-menu:hover {
        border-color: var(--primary);
      }
      .user-info {
        text-align: right;
        margin-right: 12px;
      }
      .user-name {
        font-weight: 700;
        color: var(--text-main);
        font-size: 14px;
      }
      .user-role {
        font-size: 11px;
        color: var(--text-muted);
        font-weight: 600;
        text-transform: uppercase;
      }
      .user-avatar {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        background: linear-gradient(
          135deg,
          var(--primary),
          var(--primary-dark)
        );
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
      }

      /* Profile Dropdown */
      .profile-dropdown {
        position: absolute;
        top: 60px;
        right: 0;
        width: 250px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        border: 1px solid var(--border);
        display: none;
        z-index: 2000;
        overflow: hidden;
      }
      .profile-dropdown.active {
        display: block;
        animation: fadeIn 0.2s ease-out;
      }
      .dropdown-header {
        padding: 20px;
        background: #f8fafc;
        border-bottom: 1px solid var(--border);
        text-align: center;
      }
      .dropdown-avatar {
        width: 60px;
        height: 60px;
        background: var(--primary);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        font-weight: 700;
        margin: 0 auto 10px;
        border: 3px solid white;
        box-shadow: var(--shadow-sm);
      }
      .dropdown-name {
        font-weight: 700;
        color: var(--text-main);
        font-size: 15px;
      }
      .dropdown-role {
        font-size: 11px;
        color: var(--text-muted);
        text-transform: uppercase;
        font-weight: 600;
        margin-top: 2px;
      }
      .dropdown-body {
        padding: 8px;
      }
      .dropdown-item {
        display: flex;
        align-items: center;
        padding: 10px 15px;
        color: var(--text-main);
        text-decoration: none;
        font-size: 14px;
        border-radius: 8px;
        transition: 0.2s;
        cursor: pointer;
        gap: 10px;
      }
      .dropdown-item:hover {
        background: #f1f5f9;
        color: var(--primary);
      }
      .dropdown-item.logout {
        color: var(--danger);
      }
      .dropdown-item.logout:hover {
        background: #fef2f2;
      }

      /* Form */
      .form-container {
        background: var(--bg-card);
        border-radius: 16px;
        padding: 30px;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border);
        max-width: 900px;
        margin: 0 auto;
        animation: fadeIn 0.4s ease-out;
      }
      .form-section {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px dashed var(--border);
      }
      .form-section:last-child {
        border-bottom: none;
      }
      .section-title {
        font-size: 15px;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .form-row {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
      }
      .form-col {
        flex: 1;
      }
      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        color: var(--text-main);
        font-weight: 600;
        font-size: 13px;
      }
      .required::after {
        content: " *";
        color: var(--danger);
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid var(--border);
        border-radius: 10px;
        font-size: 14px;
        outline: none;
        transition: 0.2s;
        background: #f8fafc;
      }
      input:focus,
      select:focus,
      textarea:focus {
        border-color: var(--primary);
        background: white;
        box-shadow: 0 0 0 3px var(--primary-soft);
      }

      /* Violations Grid (Modified for Selectable Cards) */
      .violations-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 15px;
        margin-top: 10px;
      }
      .violation-item {
        display: flex;
        align-items: flex-start;
        padding: 15px;
        border: 1px solid var(--border);
        border-radius: 10px;
        transition: 0.2s;
        cursor: pointer;
        background: white;
        position: relative;
      }
      .violation-item:hover {
        border-color: var(--primary);
        background: #f8fafc;
        transform: translateY(-2px);
        box-shadow: var(--shadow-sm);
      }
      .violation-item.selected {
        background: #eff6ff;
        border-color: var(--primary);
        box-shadow: 0 0 0 1px var(--primary);
      }
      /* Hide original checkbox but keep logic */
      .violation-checkbox {
        display: none;
      }

      .violation-code {
        font-weight: 700;
        color: var(--primary);
        font-size: 13px;
        margin-bottom: 2px;
      }
      .violation-description {
        font-size: 13px;
        color: var(--text-muted);
        margin: 4px 0;
        line-height: 1.4;
      }
      .violation-penalty {
        display: flex;
        gap: 10px;
        font-size: 12px;
        font-weight: 600;
        margin-top: 5px;
      }
      .fine-amount {
        color: var(--danger);
      }

      .selected-violations {
        margin-top: 20px;
        padding: 20px;
        background: #f8fafc;
        border-radius: 12px;
        border: 1px solid var(--border);
      }
      .selected-violation-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px dashed var(--border);
        font-size: 13px;
      }
      .total-penalty {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 2px solid var(--primary);
        font-weight: 800;
        color: var(--text-main);
        text-align: right;
        font-size: 16px;
      }

      .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 15px;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid var(--border);
      }
      .btn {
        padding: 12px 24px;
        border-radius: 10px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        transition: 0.2s;
      }
      .btn-primary {
        background: var(--primary);
        color: white;
        box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
      }
      .btn-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
      }
      .btn-outline {
        background: white;
        border: 1px solid var(--border);
        color: var(--text-muted);
      }
      .btn-outline:hover {
        border-color: var(--text-main);
        color: var(--text-main);
        background: #f1f5f9;
      }

      /* Modal */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(4px);
      }
      .modal-content {
        background: white;
        padding: 30px;
        border-radius: 20px;
        width: 95%;
        max-width: 450px;
        text-align: center;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        position: relative;
        animation: fadeIn 0.3s ease-out;
      }
      .close {
        position: absolute;
        right: 20px;
        top: 15px;
        font-size: 24px;
        cursor: pointer;
        color: #94a3b8;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: #f1f5f9;
      }
      .close:hover {
        background: #fee2e2;
        color: #ef4444;
      }
      #qrcodeCanvas {
        margin: 20px auto;
        padding: 10px;
        border: 1px solid var(--border);
        border-radius: 12px;
      }

      @media (max-width: 768px) {
        .sidebar {
          display: none;
        }
        .main-content {
          margin-left: 0;
          padding: 20px;
        }
        .form-row {
          flex-direction: column;
          gap: 0;
        }
        .violations-grid {
          grid-template-columns: 1fr;
        }
      }
      .text p {
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <svg viewBox="0 0 512 512" width="40" height="40" fill="white">
            <path
              d="M112,112c0-26.5,21.5-48,48-48h76.3c15.2-22,40.7-36.5,69.7-36.5s54.5,14.5,69.7,36.5H416c26.5,0,48,21.5,48,48v64H112V112z M306,83.5c-11.2,0-20.7,7.8-23.2,18.5h46.4C326.7,91.3,317.2,83.5,306,83.5z"
            />
            <path
              d="M47.5,192C21.3,192,0,213.3,0,239.5v161C0,426.7,21.3,448,47.5,448h17.1c11,27.1,37.5,46.2,68.4,46.2s57.4-19.1,68.4-46.2h161.2c11,27.1,37.5,46.2,68.4,46.2s57.4-19.1,68.4-46.2h12.1c26.2,0,47.5-21.3,47.5-47.5v-161C560,213.3,538.7,192,512.5,192H47.5z M133,456.2c-15.1,0-27.4-12.3-27.4-27.4s12.3-27.4,27.4-27.4s27.4,12.3,27.4,27.4S148.1,456.2,133,456.2z M431,456.2c-15.1,0-27.4-12.3-27.4-27.4s12.3-27.4,27.4-27.4s27.4,12.3,27.4,27.4S446.1,456.2,431,456.2z"
            />
          </svg>
        </div>
        <div class="text">
          <h2>VIMS</h2>
          <p>Impound Management</p>
        </div>
      </div>
      <div class="sidebar-menu">
        <ul>
          <li>
            <a href="officer-dashboard.html"
              ><i class="fas fa-chart-pie"></i> Dashboard</a
            >
          </li>
          <li>
            <a href="officer-add-vehicle.html" class="active"
              ><i class="fas fa-plus-circle"></i> Add Vehicle</a
            >
          </li>
          <li>
            <a href="officer-my-vehicles.html"
              ><i class="fas fa-layer-group"></i> Impounds</a
            >
          </li>
        </ul>
      </div>
      <div class="sidebar-logout">
        <ul>
          <li>
            <a href="#" id="logoutBtn"
              ><i class="fas fa-sign-out-alt"></i> Logout</a
            >
          </li>
        </ul>
      </div>
    </div>

    <div class="main-content">
      <div class="top-bar">
        <div class="page-title">
          <h1>Add Vehicle</h1>
          <p>Record a new impounded vehicle.</p>
        </div>

        <div class="user-menu" id="userMenuBtn">
          <div class="user-info">
            <div class="user-name" id="userName">Loading...</div>
            <div class="user-role" id="userRole">Officer</div>
          </div>
          <div class="user-avatar" id="userAvatar">OS</div>

          <div class="profile-dropdown" id="profileDropdown">
            <div class="dropdown-header">
              <div class="dropdown-avatar" id="dropdownAvatar">?</div>
              <div class="dropdown-name" id="dropdownName">User Name</div>
              <div class="dropdown-role" id="dropdownRole">Role</div>
            </div>
            <div class="dropdown-body">
              <a class="dropdown-item"
                ><i class="fas fa-cog" style="color: var(--text-muted)"></i>
                Settings</a
              >
              <hr
                style="border: 0; border-top: 1px solid #eee; margin: 5px 0"
              />
              <a class="dropdown-item logout" id="logoutBtnDropdown"
                ><i class="fas fa-sign-out-alt"></i> Logout</a
              >
            </div>
          </div>
        </div>
      </div>

      <div class="form-container">
        <form id="impoundForm">
          <div class="form-section">
            <h3 class="section-title">
              <i class="fas fa-user-circle"></i> Owner Information
            </h3>
            <div class="form-row">
              <div class="form-col">
                <div class="form-group">
                  <label for="ownerName">Owner's Full Name</label>
                  <input
                    type="text"
                    id="ownerName"
                    placeholder="e.g., Maria Santos Cruz (optional)"
                  />
                </div>
              </div>
              <div class="form-col">
                <div class="form-group">
                  <label for="ownerContact">Contact Number</label>
                  <input
                    type="text"
                    id="ownerContact"
                    placeholder="e.g., 0917xxxxxxx (optional)"
                  />
                </div>
              </div>
            </div>

            <div class="form-group">
              <label for="ownerEmail">Email Address (Optional)</label>
              <input
                type="email"
                id="ownerEmail"
                placeholder="e.g., owner@example.com"
              />
              <small
                style="
                  color: var(--text-muted);
                  font-size: 12px;
                  margin-top: 5px;
                  display: block;
                "
                >QR Code will be sent to this email automatically.</small
              >
            </div>

            <div class="form-group">
              <label for="ownerAddress">Owner Address</label>
              <textarea
                id="ownerAddress"
                rows="2"
                placeholder="Complete address (optional)"
              ></textarea>
            </div>
          </div>

          <div class="form-section">
            <h3 class="section-title">
              <i class="fas fa-car-side"></i> Vehicle Details
            </h3>
            <div class="form-row">
              <div class="form-col">
                <div class="form-group">
                  <label for="plateNumber" class="required">Plate Number</label>
                  <input
                    type="text"
                    id="plateNumber"
                    placeholder="e.g., ABC 1234"
                    required
                  />
                </div>
              </div>
              <div class="form-col">
                <div class="form-group">
                  <label for="vehicleType" class="required">Vehicle Type</label>
                  <select id="vehicleType" required>
                    <option value="">Select Type</option>
                    <option value="sedan">Sedan</option>
                    <option value="suv">SUV</option>
                    <option value="motorcycle">Motorcycle</option>
                    <option value="van">Van</option>
                    <option value="truck">Truck</option>
                    <option value="tricycle">Tricycle</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="form-row">
              <div class="form-col">
                <div class="form-group">
                  <label for="vehicleModel" class="required">Model</label>
                  <input
                    type="text"
                    id="vehicleModel"
                    placeholder="e.g., Toyota Vios"
                    required
                  />
                </div>
              </div>
              <div class="form-col">
                <div class="form-group">
                  <label for="vehicleColor" class="required">Color</label>
                  <input
                    type="text"
                    id="vehicleColor"
                    placeholder="e.g., Red"
                    required
                  />
                </div>
              </div>
            </div>
          </div>

          <div class="form-section">
            <h3 class="section-title">
              <i class="fas fa-exclamation-triangle"></i> Violations
            </h3>
            <div class="form-group">
              <label class="required">Select Violations</label>
              <div class="violations-grid" id="violationsContainer">
                <div
                  style="
                    padding: 20px;
                    color: var(--text-muted);
                    text-align: center;
                  "
                >
                  <i class="fas fa-circle-notch fa-spin"></i> Loading
                  violations...
                </div>
              </div>
            </div>
            <div
              class="selected-violations"
              id="selectedViolations"
              style="display: none"
            >
              <h4
                style="
                  font-size: 13px;
                  font-weight: 700;
                  margin-bottom: 10px;
                  color: var(--text-muted);
                  text-transform: uppercase;
                "
              >
                Summary
              </h4>
              <div id="selectedViolationsList"></div>
              <div class="total-penalty" id="totalPenalty">Total: ‚Ç±0.00</div>
            </div>
          </div>

          <div class="form-section">
            <h3 class="section-title">
              <i class="fas fa-map-marker-alt"></i> Impound Data
            </h3>
            <div class="form-row">
              <div class="form-col">
                <div class="form-group">
                  <label for="impoundDate" class="required">Date</label>
                  <input type="date" id="impoundDate" required />
                </div>
              </div>
              <div class="form-col">
                <div class="form-group">
                  <label for="impoundTime" class="required">Time</label>
                  <input type="time" id="impoundTime" required />
                </div>
              </div>
            </div>
            <div class="form-row">
              <div class="form-col">
                <div class="form-group">
                  <label for="slotNumber" class="required">Slot Number</label>
                  <input
                    type="text"
                    id="slotNumber"
                    placeholder="e.g., A-15"
                    required
                  />
                </div>
              </div>
              <div class="form-col">
                <div class="form-group">
                  <label for="towingLocation">Towing Location</label>
                  <input
                    type="text"
                    id="towingLocation"
                    placeholder="Location"
                  />
                </div>
              </div>
            </div>
            <div class="form-group">
              <label for="violationDescription">Additional Description</label>
              <textarea
                id="violationDescription"
                rows="2"
                placeholder="Details..."
              ></textarea>
            </div>
            <div class="form-group">
              <label for="conditionNotes">Vehicle Condition</label>
              <textarea
                id="conditionNotes"
                rows="2"
                placeholder="Scratches, dents..."
              ></textarea>
            </div>
          </div>

          <div class="form-actions">
            <button
              type="button"
              class="btn btn-outline"
              onclick="window.location.href='officer-dashboard.html'"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="btn btn-primary"
              id="saveAndGenerateBtn"
            >
              <i class="fas fa-qrcode"></i> Save & Generate QR
            </button>
          </div>
        </form>
      </div>
    </div>

    <div id="qrModal" class="modal">
      <div class="modal-content">
        <span class="close" id="closeModal">&times;</span>
        <div style="text-align: center">
          <div
            style="
              width: 60px;
              height: 60px;
              background: #ecfdf5;
              color: #10b981;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              margin: 0 auto 15px;
              font-size: 30px;
            "
          >
            <i class="fas fa-check"></i>
          </div>
          <h2
            style="
              font-size: 20px;
              font-weight: 800;
              margin-bottom: 5px;
              color: var(--text-main);
            "
          >
            Vehicle Impounded
          </h2>
          <p style="color: var(--text-muted); font-size: 14px">
            QR Code generated successfully.
          </p>
        </div>

        <canvas id="qrcodeCanvas"></canvas>

        <div
          style="
            background: var(--bg-body);
            padding: 15px;
            border-radius: 12px;
            text-align: left;
            margin-bottom: 20px;
          "
        >
          <div
            style="
              display: flex;
              justify-content: space-between;
              margin-bottom: 5px;
            "
          >
            <span style="color: var(--text-muted); font-size: 13px"
              >Plate:</span
            >
            <span
              style="font-weight: 700; color: var(--text-main)"
              id="modalPlateNumber"
            ></span>
          </div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              margin-bottom: 5px;
            "
          >
            <span style="color: var(--text-muted); font-size: 13px"
              >Reference:</span
            >
            <span
              style="
                font-weight: 700;
                color: var(--text-main);
                font-family: monospace;
              "
              id="modalRefNumber"
            ></span>
          </div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              margin-bottom: 5px;
            "
          >
            <span style="color: var(--text-muted); font-size: 13px"
              >Owner:</span
            >
            <span
              style="font-weight: 600; color: var(--text-main)"
              id="modalOwnerName"
            ></span>
          </div>
          <div style="display: flex; justify-content: space-between">
            <span style="color: var(--text-muted); font-size: 13px"
              >Total Fine:</span
            >
            <span
              style="color: var(--danger); font-weight: 700"
              id="modalTotalFine"
            ></span>
          </div>
        </div>

        <div style="display: grid; gap: 10px">
          <button
            class="btn btn-primary"
            onclick="printQrSticker()"
            style="justify-content: center; width: 100%"
          >
            <i class="fas fa-print"></i> Print Sticker
          </button>
          <button
            class="btn btn-outline"
            onclick="closeModalAndRedirect()"
            style="justify-content: center; width: 100%"
          >
            Close & View List
          </button>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        doc,
        updateDoc,
        getDocs,
        query,
        where,
      } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";
      import {
        getAuth,
        signOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyByzd88bcUAq0VdP0w6oB8W_b2AUgoIzXc",
        authDomain: "vehicle-impound.firebaseapp.com",
        projectId: "vehicle-impound",
        storageBucket: "vehicle-impound.appspot.com",
        messagingSenderId: "69239563292",
        appId: "1:69239563292:web:281912e8a38301c0feabd9",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      // Elements
      const impoundForm = document.getElementById("impoundForm");
      const qrModal = document.getElementById("qrModal");
      const closeModalBtn = document.getElementById("closeModal");
      const saveBtn = document.getElementById("saveAndGenerateBtn");
      const qrcodeCanvas = document.getElementById("qrcodeCanvas");
      const violationsContainer = document.getElementById(
        "violationsContainer"
      );
      const selectedViolationsDiv =
        document.getElementById("selectedViolations");
      const selectedViolationsList = document.getElementById(
        "selectedViolationsList"
      );
      const totalPenaltyDiv = document.getElementById("totalPenalty");

      // Dropdown Elements
      const userMenuBtn = document.getElementById("userMenuBtn");
      const profileDropdown = document.getElementById("profileDropdown");

      let selectedViolations = [];
      let violationsData = [];
      let currentUser = null;

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          await loadUserData(user);
          await fetchViolations();
        } else {
          window.location.href = "../index.html";
        }
      });

      // --- DROPDOWN LOGIC ---
      userMenuBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        profileDropdown.classList.toggle("active");
        userMenuBtn.classList.toggle("active");
      });

      document.addEventListener("click", (e) => {
        if (
          !userMenuBtn.contains(e.target) &&
          !profileDropdown.contains(e.target)
        ) {
          profileDropdown.classList.remove("active");
          userMenuBtn.classList.remove("active");
        }
      });

      document.getElementById("logoutBtn").addEventListener("click", logout);
      document
        .getElementById("logoutBtnDropdown")
        .addEventListener("click", logout);

      async function loadUserData(firebaseUser) {
        try {
          const q = query(
            collection(db, "users"),
            where("email", "==", firebaseUser.email)
          );
          const snap = await getDocs(q);
          if (!snap.empty) {
            const d = snap.docs[0].data();

            // Map Data
            currentUser = {
              uid: firebaseUser.uid,
              readableId: d.readableId,
              fullName: d.fullName, // Fetched Correctly
              role: d.role,
              email: d.email,
            };

            updateUserProfileUI();
          }
        } catch (error) {
          console.error(error);
        }
      }

      function updateUserProfileUI() {
        const name = currentUser.fullName || "Officer";
        const role = currentUser.role || "Officer";
        const initials = name
          .split(" ")
          .map((n) => n[0])
          .join("")
          .substring(0, 2)
          .toUpperCase();

        // Update UI
        document.getElementById("userName").textContent = name;
        document.getElementById("userRole").textContent = role.toUpperCase();
        document.getElementById("userAvatar").textContent = initials;

        document.getElementById("dropdownName").textContent = name;
        document.getElementById("dropdownRole").textContent =
          role.toUpperCase();
        document.getElementById("dropdownAvatar").textContent = initials;
      }

      async function logout() {
        await signOut(auth);
        window.location.href = "../index.html";
      }

      // --- REFERENCE NUMBER GENERATOR ---
      function generateReferenceNumber() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, "0");
        const day = String(now.getDate()).padStart(2, "0");
        const randomNum = Math.floor(Math.random() * 900) + 100; // 100-999

        return `IMP-${year}${month}${day}-${randomNum}`;
      }

      // --- VIOLATIONS LOGIC ---
      async function fetchViolations() {
        try {
          const violationsQuery = query(
            collection(db, "violations"),
            where("status", "==", "active")
          );
          const querySnapshot = await getDocs(violationsQuery);
          violationsData = [];
          querySnapshot.forEach((doc) => {
            const violation = doc.data();
            violationsData.push({
              id: doc.id,
              code: violation.code,
              description: violation.description,
              fineAmount: violation.fineAmount,
              penaltyPoints: violation.penaltyPoints,
            });
          });
          initializeViolations();
        } catch (error) {
          console.error("Error fetching violations:", error);
          violationsContainer.innerHTML =
            '<div style="color:red">Error loading violations.</div>';
        }
      }

      function initializeViolations() {
        violationsContainer.innerHTML = "";
        if (violationsData.length === 0) {
          violationsContainer.innerHTML =
            "<div>No active violations found.</div>";
          return;
        }
        violationsData.forEach((violation) => {
          const item = document.createElement("div");
          item.className = "violation-item";
          // Hidden Checkbox Logic (Visual Selection)
          item.innerHTML = `
                <input type="checkbox" class="violation-checkbox" value="${
                  violation.code
                }" 
                        data-id="${violation.id}" data-fine="${
            violation.fineAmount
          }" data-points="${violation.penaltyPoints}">
                <div style="flex:1;">
                    <div class="violation-code">${violation.code}</div>
                    <div class="violation-description">${
                      violation.description
                    }</div>
                    <div class="violation-penalty">
                        <span class="fine-amount">‚Ç±${violation.fineAmount.toLocaleString()}</span>
                        <span style="color:var(--text-muted);">‚Ä¢ ${
                          violation.penaltyPoints
                        } pts</span>
                    </div>
                </div>
                <div class="check-icon" style="color:var(--primary); display:none;"><i class="fas fa-check-circle"></i></div>
            `;

          violationsContainer.appendChild(item);

          // Click Handler
          item.addEventListener("click", (e) => {
            const cb = item.querySelector(".violation-checkbox");
            cb.checked = !cb.checked;
            updateSelectedViolations(cb);

            // Toggle Visuals
            item.classList.toggle("selected", cb.checked);
            const icon = item.querySelector(".check-icon");
            if (icon) icon.style.display = cb.checked ? "block" : "none";
          });
        });
      }

      function updateSelectedViolations(checkbox) {
        const code = checkbox.value;
        const id = checkbox.dataset.id;
        const vData = violationsData.find((v) => v.code === code);

        if (checkbox.checked) {
          if (!selectedViolations.find((v) => v.code === code)) {
            selectedViolations.push({ ...vData, violationId: id });
          }
        } else {
          selectedViolations = selectedViolations.filter(
            (v) => v.code !== code
          );
        }
        updateSelectedViolationsDisplay();
      }

      function updateSelectedViolationsDisplay() {
        if (selectedViolations.length === 0) {
          selectedViolationsDiv.style.display = "none";
          return;
        }
        selectedViolationsDiv.style.display = "block";
        selectedViolationsList.innerHTML = "";
        let tFine = 0,
          tPoints = 0;

        selectedViolations.forEach((v) => {
          tFine += v.fineAmount;
          tPoints += v.penaltyPoints;
          const div = document.createElement("div");
          div.className = "selected-violation-item";
          div.innerHTML = `<span style="font-weight:600; color:var(--primary);">${
            v.code
          }</span><span style="font-weight:600;">‚Ç±${v.fineAmount.toLocaleString()}</span>`;
          selectedViolationsList.appendChild(div);
        });
        totalPenaltyDiv.innerHTML = `Total: ‚Ç±${tFine.toLocaleString()} | Pts: ${tPoints}`;
      }

      async function generateQrCode(data) {
        return new Promise((resolve, reject) => {
          // Clear canvas first
          const ctx = qrcodeCanvas.getContext("2d");
          ctx.clearRect(0, 0, qrcodeCanvas.width, qrcodeCanvas.height);

          console.log("üîµ Generating QR code for:", data);

          QRCode.toCanvas(
            qrcodeCanvas,
            data,
            {
              width: 250,
              margin: 2,
              errorCorrectionLevel: "M",
              color: {
                dark: "#000000",
                light: "#FFFFFF",
              },
            },
            (err) => {
              if (err) {
                console.error("‚ùå QR Generation Failed:", err);
                reject(err);
              } else {
                console.log("‚úÖ QR Code generated successfully");
                resolve(qrcodeCanvas.toDataURL("image/png"));
              }
            }
          );
        });
      }
      // --- BREVO EMAIL ---
      async function sendQrEmail(email, name, plate, qrBase64) {
        await fetch("/api/send-email", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            email,
            name,
            plate,
            qrBase64,
          }),
        });
      }

      async function createPaymentRecord(vehicleId, totalFine, codes, date) {
        const d = new Date(date);
        let added = 0;
        while (added < 7) {
          d.setDate(d.getDate() + 1);
          const day = d.getDay();
          if (day !== 0 && day !== 6) added++;
        }

        await addDoc(collection(db, "payments"), {
          vehicleId,
          violationCode: codes.join(", "),
          totalFine,
          paymentStatus: "unpaid",
          balance: totalFine,
          amountPaid: 0,
          paymentDate: d.toISOString(),
          cashierId: "",
          receipt: "",
          remarks: "Payment due in 7 working days",
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString(),
        });
      }

      async function createActivityLog(action, vehicleId, details) {
        await addDoc(collection(db, "activityLogs"), {
          action,
          vehicleId,
          userId: currentUser.readableId,
          fullName: currentUser.fullName,
          timestamp: new Date().toISOString(),
          details,
        });
      }

      // --- SUBMIT LOGIC ---
      impoundForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        if (selectedViolations.length === 0) {
          alert("Please select at least one violation");
          return;
        }

        saveBtn.disabled = true;
        saveBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Processing...';

        const totalFine = selectedViolations.reduce(
          (sum, v) => sum + v.fineAmount,
          0
        );
        const totalPoints = selectedViolations.reduce(
          (sum, v) => sum + v.penaltyPoints,
          0
        );
        const violationCodes = selectedViolations.map((v) => v.code);
        const violationIds = selectedViolations.map((v) => v.violationId);

        const impoundDateInput = document.getElementById("impoundDate").value;
        const impoundTimeInput = document.getElementById("impoundTime").value;
        const timestampDate = new Date(
          `${impoundDateInput}T${impoundTimeInput}`
        );

        const plateNumber = document
          .getElementById("plateNumber")
          .value.toUpperCase()
          .trim();
        const ownerName = document.getElementById("ownerName").value.trim();
        const ownerEmail = document.getElementById("ownerEmail").value.trim();

        const referenceNumber = generateReferenceNumber(); // Generate reference

        const formData = {
          referenceNumber: referenceNumber, // ADDED: Reference number
          ownerName: ownerName,
          ownerEmail: ownerEmail,
          ownerContact: document.getElementById("ownerContact").value.trim(),
          ownerAddress: document.getElementById("ownerAddress").value.trim(),
          plateNumber: plateNumber,
          vehicleType: document.getElementById("vehicleType").value,
          vehicleModel: document.getElementById("vehicleModel").value.trim(),
          vehicleColor: document.getElementById("vehicleColor").value.trim(),
          violationCode: violationCodes.join(", "),
          violationIds: violationIds,
          violationDescription:
            document.getElementById("violationDescription").value.trim() ||
            selectedViolations.map((v) => v.description).join(", "),
          fineAmount: totalFine,
          penaltyPoints: totalPoints,
          impoundDate: timestampDate,
          impoundTime: impoundTimeInput,
          slotNumber: document
            .getElementById("slotNumber")
            .value.toUpperCase()
            .trim(),
          towingLocation: document
            .getElementById("towingLocation")
            .value.trim(),
          conditionNotes: document
            .getElementById("conditionNotes")
            .value.trim(),
          impoundingOfficerId: currentUser.readableId,
          impoundingOfficerName: currentUser.fullName,
          department: "impound",
          status: "impounded",
          photoUrls: [],
          qrCodeImage: null,
          qrData: null,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString(),
        };

        try {
          const docRef = await addDoc(
            collection(db, "impoundedVehicles"),
            formData
          );
          const docId = docRef.id;

          await createPaymentRecord(
            docId,
            totalFine,
            violationCodes,
            impoundDateInput
          );

          // Get current page path and construct proper base URL
          const protocol = window.location.protocol;
          const host = window.location.host;
          const currentPath = window.location.pathname;

          // Remove the current file from path
          const pathArray = currentPath.split("/");
          pathArray.pop(); // Remove 'officer-add-vehicle.html'
          const basePath = pathArray.join("/");

          // Build full scanner URL
          const scannerUrl = `${protocol}//${host}${basePath}/scanner.html?id=${docId}`;

          console.log("üîµ Full Scanner URL:", scannerUrl);
          console.log("üîµ Vehicle ID:", docId);

          // Generate QR with the full URL
          const qrImageBase64 = await generateQrCode(scannerUrl);

          await updateDoc(doc(db, "impoundedVehicles", docId), {
            qrCodeImage: qrImageBase64,
            qrData: docId,
            vehicleId: docId,
          });

          await createActivityLog(
            "impounded",
            docId,
            `Vehicle ${plateNumber} impounded.`
          );

          if (ownerEmail) {
            await sendQrEmail(
              ownerEmail,
              ownerName,
              plateNumber,
              qrImageBase64
            );
          }

          document.getElementById("modalPlateNumber").textContent = plateNumber;
          document.getElementById("modalOwnerName").textContent =
            ownerName || "N/A";
          document.getElementById("modalRefNumber").textContent =
            referenceNumber; // ADDED: Display reference number
          document.getElementById(
            "modalTotalFine"
          ).textContent = `‚Ç±${totalFine.toLocaleString()}`;
          qrModal.style.display = "flex";

          impoundForm.reset();
          document.getElementById("impoundDate").value = new Date()
            .toISOString()
            .split("T")[0];
          selectedViolations = [];
          updateSelectedViolationsDisplay();
          initializeViolations();
        } catch (error) {
          console.error("Error:", error);
          alert("Error: " + error.message);
        } finally {
          saveBtn.disabled = false;
          saveBtn.innerHTML =
            '<i class="fas fa-qrcode"></i> Save & Generate QR';
        }
      });

      window.printQrSticker = function () {
        const url = qrcodeCanvas.toDataURL("image/png");
        const w = window.open("", "", "width=400,height=400");
        w.document.write(
          `<html><body style="text-align:center; font-family:sans-serif;"><br><img src="${url}" style="border:2px solid black; padding:10px;"><h3>${
            document.getElementById("modalPlateNumber").textContent
          }</h3><p>Reference: ${
            document.getElementById("modalRefNumber").textContent
          }</p><p>Date: ${
            document.getElementById("impoundDate").value
          }</p><script>window.print();window.close()<\/script></body></html>`
        );
      };

      window.closeModalAndRedirect = function () {
        qrModal.style.display = "none";
        window.location.href = "officer-my-vehicles.html";
      };

      closeModalBtn.onclick = () => (qrModal.style.display = "none");
      window.onclick = (e) => {
        if (e.target == qrModal) qrModal.style.display = "none";
      };

      // Init Date
      document.getElementById("impoundDate").value = new Date()
        .toISOString()
        .split("T")[0];
    </script>
  </body>
</html>
