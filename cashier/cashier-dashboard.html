<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cashier Dashboard - VIMS</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <!-- Add jsPDF library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
      :root {
        /* VIMS Modern Palette */
        --primary: #2563eb;
        --primary-dark: #1e40af;
        --sidebar-bg: #1e293b;
        --bg-body: #f1f5f9;
        --bg-card: #ffffff;
        --text-main: #0f172a;
        --text-muted: #64748b;
        --success: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
        --border: #e2e8f0;
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --radius: 12px;
        --anim-speed: 0.25s;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Inter", "Segoe UI", Roboto, sans-serif;
      }

      body {
        background-color: var(--bg-body);
        display: flex;
        min-height: 100vh;
        color: var(--text-main);
        overflow-x: hidden;
      }

      /* Animations */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Sidebar */
      .sidebar {
        width: 260px;
        background: linear-gradient(145deg, #0f172a 0%, #1e293b 100%);
        color: white;
        height: 100vh;
        position: fixed;
        left: 0;
        top: 0;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        box-shadow: 4px 0 20px rgba(0, 0, 0, 0.15);
        transition: var(--anim-speed);
      }
      .sidebar-header {
        padding: 30px 24px;
        display: flex;
        align-items: center;
        gap: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        background: transparent;
        flex-shrink: 0;
      }
      .logo svg {
        width: 40px;
        height: 40px;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
      }
      .sidebar-header h2 {
        font-size: 20px;
        font-weight: 700;
        letter-spacing: 0.5px;
      }
      .sidebar-menu {
        padding: 20px 15px;
        flex: 1;
        overflow-y: auto;
      }
      .sidebar-menu ul {
        list-style: none;
      }
      .sidebar-menu li {
        margin-bottom: 5px;
      }
      .sidebar-menu a {
        display: flex;
        align-items: center;
        padding: 14px 20px;
        color: #94a3b8;
        text-decoration: none;
        transition: var(--anim-speed);
        border-radius: 8px;
        font-weight: 500;
        font-size: 14px;
        border-left: none;
      }
      .sidebar-menu a:hover,
      .sidebar-menu a.active {
        background-color: rgba(255, 255, 255, 0.08);
        color: white;
      }
      .sidebar-menu a.active {
        background: var(--primary);
        color: white;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
      }
      .sidebar-menu i {
        margin-right: 12px;
        width: 20px;
        text-align: center;
        font-size: 16px;
      }
      /* FIXED: Logout at very bottom */
      .sidebar-logout {
        padding: 20px;
        background: rgba(0, 0, 0, 0.2);
        border-top: 1px solid rgba(255, 255, 255, 0.08);
        /* No margin-top needed because sidebar-content is flex column */
      }
      .sidebar-logout ul {
        list-style: none;
      }
      .sidebar-logout a {
        display: flex;
        align-items: center;
        padding: 12px 15px;
        color: #fca5a5;
        text-decoration: none;
        transition: 0.3s;
        border-radius: 8px;
        font-weight: 500;
      }
      .sidebar-logout a:hover {
        background-color: rgba(239, 68, 68, 0.15);
        color: #f87171;
      }
      .sidebar-logout i {
        margin-right: 12px;
        width: 20px;
        text-align: center;
      }

      /* Main Content */
      .main-content {
        flex: 1;
        margin-left: 260px;
        padding: 30px 40px;
        transition: var(--anim-speed);
      }
      .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 35px;
        padding-bottom: 0;
        border-bottom: none;
      }
      .page-title h1 {
        font-size: 26px;
        color: var(--text-main);
        font-weight: 800;
        letter-spacing: -0.5px;
        margin-bottom: 5px;
      }
      .page-title p {
        color: var(--text-muted);
        font-size: 14px;
      }

      /* User Menu */
      .user-menu {
        display: flex;
        align-items: center;
        position: relative;
        padding: 6px 8px 6px 16px;
        border-radius: 50px;
        background: white;
        border: 1px solid var(--border);
        box-shadow: var(--shadow-sm);
        cursor: pointer;
        transition: 0.2s;
      }
      .user-menu:hover {
        box-shadow: var(--shadow-md);
        border-color: var(--primary);
      }
      .user-info {
        text-align: right;
        margin-right: 12px;
      }
      .user-name {
        font-weight: 700;
        color: var(--text-main);
        font-size: 14px;
      }
      .user-role {
        font-size: 11px;
        color: var(--text-muted);
        font-weight: 600;
        text-transform: uppercase;
      }
      .user-avatar {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        background: linear-gradient(
          135deg,
          var(--primary),
          var(--primary-dark)
        );
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
      }

      /* Dropdown */
      .logout-dropdown {
        position: absolute;
        top: 60px;
        right: 0;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        padding: 10px;
        min-width: 200px;
        display: none;
        z-index: 1000;
        border: 1px solid var(--border);
        animation: fadeIn 0.2s ease-out;
      }
      .logout-dropdown.show {
        display: block;
      }
      .logout-item {
        padding: 12px 15px;
        display: flex;
        align-items: center;
        color: var(--text-main);
        text-decoration: none;
        transition: 0.2s;
        cursor: pointer;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
        font-size: 14px;
        border-radius: 8px;
      }
      .logout-item:hover {
        background-color: var(--bg-body);
        color: var(--primary);
      }
      .logout-item i {
        margin-right: 10px;
        width: 16px;
      }

      /* Dashboard Stats */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 24px;
        margin-bottom: 35px;
        animation: fadeIn 0.4s ease-out;
      }
      .stat-card {
        background: var(--bg-card);
        border-radius: var(--radius);
        box-shadow: var(--shadow-sm);
        padding: 25px;
        transition: 0.3s;
        border: 1px solid var(--border);
        position: relative;
        overflow: hidden;
      }
      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-md);
        border-color: var(--primary);
      }
      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10px;
      }
      .card-title {
        font-size: 13px;
        color: var(--text-muted);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .card-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 18px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .stat-value {
        font-size: 32px;
        font-weight: 800;
        color: var(--text-main);
        margin-bottom: 5px;
        letter-spacing: -1px;
      }
      .card-change {
        font-size: 13px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 5px;
        color: var(--text-muted);
      }
      .card-change.positive {
        color: var(--success);
      }
      .card-change.negative {
        color: var(--danger);
      }

      /* Quick Actions */
      .quick-actions {
        margin-bottom: 35px;
      }
      .section-title {
        font-size: 16px;
        color: var(--text-main);
        margin-bottom: 15px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .action-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 20px;
      }
      .action-btn {
        background: white;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
        text-decoration: none;
        color: var(--text-main);
        transition: 0.2s;
        box-shadow: var(--shadow-sm);
        cursor: pointer;
        border: none;
        text-align: left;
      }
      .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
        border-color: var(--primary);
      }
      .action-icon {
        width: 45px;
        height: 45px;
        border-radius: 10px;
        background: #eff6ff;
        color: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
      }
      .action-text {
        font-weight: 600;
        font-size: 14px;
      }

      /* Table Area */
      .data-table {
        background: var(--bg-card);
        border-radius: var(--radius);
        box-shadow: var(--shadow-sm);
        overflow: hidden;
        margin-bottom: 30px;
        border: 1px solid var(--border);
        animation: fadeIn 0.5s ease-out;
      }
      .table-header {
        padding: 20px 25px;
        background: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--border);
      }
      .table-title {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-main);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        white-space: nowrap;
      }
      th {
        background: #f8fafc;
        padding: 16px 24px;
        text-align: left;
        font-weight: 600;
        color: var(--text-muted);
        font-size: 12px;
        text-transform: uppercase;
        border-bottom: 1px solid var(--border);
        letter-spacing: 0.5px;
      }
      td {
        padding: 16px 24px;
        border-bottom: 1px solid var(--border);
        color: var(--text-main);
        font-size: 14px;
        vertical-align: middle;
      }
      tr:last-child td {
        border-bottom: none;
      }
      tr:hover td {
        background-color: #f8fafc;
        transition: background 0.2s;
      }

      .status {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: inline-block;
      }
      .status-paid {
        background: #dcfce7;
        color: #166534;
        border: 1px solid #86efac;
      }
      .status-partial {
        background: #eff6ff;
        color: #1e40af;
        border: 1px solid #bfdbfe;
      }
      .status-pending {
        background: #fef9c3;
        color: #854d0e;
        border: 1px solid #fde047;
      }

      .action-cell {
        display: flex;
        gap: 8px;
      }
      .action-icon-btn {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: 0.2s;
        border: 1px solid transparent;
      }
      .action-view {
        background: #f1f5f9;
        color: var(--sidebar-bg);
      }
      .action-view:hover {
        background: var(--sidebar-bg);
        color: white;
      }

      .action-process {
        background: #eff6ff;
        color: var(--primary);
        border-color: #bfdbfe;
      }
      .action-process:hover {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }

      /* Index Help */
      .index-help {
        background-color: #fffbeb;
        border-bottom: 1px solid #fcd34d;
        padding: 15px 25px;
        color: #92400e;
        font-size: 13px;
      }
      .index-help a {
        color: var(--primary);
        font-weight: 600;
      }

      /* Modal Styling */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(4px);
        animation: fadeIn 0.2s;
      }
      .modal-content {
        background-color: white;
        border-radius: 16px;
        width: 95%;
        max-width: 900px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
      }
      .modal-header {
        padding: 20px 30px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: white;
        position: sticky;
        top: 0;
        z-index: 10;
      }
      .modal-header h2 {
        margin: 0;
        font-size: 18px;
        font-weight: 700;
        color: var(--text-main);
      }
      .close {
        background: #f1f5f9;
        border: none;
        color: var(--text-muted);
        font-size: 20px;
        cursor: pointer;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: 0.2s;
      }
      .close:hover {
        background: #e2e8f0;
        color: var(--danger);
      }
      .modal-body {
        padding: 30px;
      }

      .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }
      .info-card {
        background: white;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
      }
      .info-card h3 {
        color: var(--text-main);
        margin-bottom: 15px;
        font-size: 14px;
        font-weight: 700;
        text-transform: uppercase;
        border-bottom: 1px solid var(--border);
        padding-bottom: 10px;
      }
      .info-item {
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        font-size: 13px;
      }
      .info-label {
        color: var(--text-muted);
      }
      .info-value {
        color: var(--text-main);
        font-weight: 600;
      }

      .fee-breakdown {
        background: #f8fafc;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
      }
      .fee-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        font-size: 13px;
        border-bottom: 1px dashed var(--border);
      }
      .fee-item:last-child {
        border-bottom: none;
      }
      .total-amount {
        display: flex;
        justify-content: space-between;
        padding-top: 15px;
        margin-top: 10px;
        border-top: 2px solid var(--primary);
        font-size: 16px;
        font-weight: 700;
        color: var(--text-main);
      }

      .violations-list {
        margin-top: 10px;
        max-height: 150px;
        overflow-y: auto;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 10px;
        background: #f8fafc;
      }
      .violation-item {
        padding: 10px;
        margin-bottom: 5px;
        background: white;
        border: 1px solid var(--border);
        border-radius: 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .violation-code {
        font-weight: 700;
        font-size: 12px;
        color: var(--primary);
      }
      .violation-description {
        font-size: 12px;
        color: var(--text-muted);
        flex: 1;
        margin-left: 10px;
      }
      .violation-fine {
        color: var(--danger);
        font-weight: 600;
        font-size: 12px;
      }

      /* Report Modal Styling */
      .report-modal-content {
        background-color: white;
        border-radius: 16px;
        width: 95%;
        max-width: 500px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
      }
      .report-form {
        padding: 30px;
      }
      .form-group {
        margin-bottom: 20px;
      }
      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--text-main);
        font-size: 14px;
      }
      .form-group input,
      .form-group select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 14px;
        outline: none;
        transition: border-color 0.2s;
      }
      .form-group input:focus,
      .form-group select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }
      .report-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 30px;
      }

      /* Loading overlay */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 3000;
        backdrop-filter: blur(4px);
      }
      .loading-content {
        background: white;
        padding: 30px;
        border-radius: 16px;
        text-align: center;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      }
      .loading-content i {
        font-size: 40px;
        color: var(--primary);
        margin-bottom: 15px;
        display: block;
      }
      .loading-content p {
        color: var(--text-main);
        font-weight: 600;
        margin-bottom: 10px;
      }
      .loading-content .progress {
        font-size: 12px;
        color: var(--text-muted);
      }

      @media (max-width: 768px) {
        .sidebar {
          display: none;
        }
        .main-content {
          margin-left: 0;
          padding: 20px;
        }
        .stats-grid,
        .action-buttons {
          grid-template-columns: 1fr;
        }
        .header-left {
          flex-direction: column;
          width: 100%;
        }
        .info-grid {
          grid-template-columns: 1fr;
        }
        .report-modal-content {
          width: 95%;
          max-width: 95%;
        }
      }
      .text p {
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <svg viewBox="0 0 512 512" width="40" height="40" fill="white">
            <path
              d="M112,112c0-26.5,21.5-48,48-48h76.3c15.2-22,40.7-36.5,69.7-36.5s54.5,14.5,69.7,36.5H416c26.5,0,48,21.5,48,48v64H112V112z M306,83.5c-11.2,0-20.7,7.8-23.2,18.5h46.4C326.7,91.3,317.2,83.5,306,83.5z"
            />
            <path
              d="M47.5,192C21.3,192,0,213.3,0,239.5v161C0,426.7,21.3,448,47.5,448h17.1c11,27.1,37.5,46.2,68.4,46.2s57.4-19.1,68.4-46.2h161.2c11,27.1,37.5,46.2,68.4,46.2s57.4-19.1,68.4-46.2h12.1c26.2,0,47.5-21.3,47.5-47.5v-161C560,213.3,538.7,192,512.5,192H47.5z M133,456.2c-15.1,0-27.4-12.3-27.4-27.4s12.3-27.4,27.4-27.4s27.4,12.3,27.4,27.4S148.1,456.2,133,456.2z M431,456.2c-15.1,0-27.4-12.3-27.4-27.4s12.3-27.4,27.4-27.4s27.4,12.3,27.4,27.4S446.1,456.2,431,456.2z"
            />
          </svg>
        </div>
        <div class="text">
          <h2>VIMS</h2>
          <p>Payments Management</p>
        </div>
      </div>
      <div class="sidebar-menu">
        <ul>
          <li>
            <a href="cashier-dashboard.html" class="active"
              ><i class="fas fa-tachometer-alt"></i> Dashboard</a
            >
          </li>
          <li>
            <a href="cashier-pending-payments.html"
              ><i class="fas fa-clock"></i> Pending Payments</a
            >
          </li>
          <li>
            <a href="cashier-payment-history.html"
              ><i class="fas fa-history"></i> Transaction History</a
            >
          </li>
        </ul>
      </div>
      <div class="sidebar-logout">
        <ul>
          <li>
            <a href="#" onclick="logout()"
              ><i class="fas fa-sign-out-alt"></i> Logout</a
            >
          </li>
        </ul>
      </div>
    </div>

    <div class="main-content">
      <div class="top-bar">
        <div class="page-title">
          <h1>Cashier Dashboard</h1>
          <p>Welcome back, Cashier. Manage payments and transactions.</p>
        </div>
        <div class="user-menu" onclick="toggleLogoutDropdown()">
          <div class="user-info">
            <div class="user-name" id="userDisplayName">Loading...</div>
            <div class="user-role" id="userRole">Cashier</div>
          </div>
          <div class="user-avatar" id="userAvatar">CM</div>
          <div class="logout-dropdown" id="logoutDropdown">
            <button class="logout-item">
              <i class="fas fa-user"></i> My Profile
            </button>
            <button
              class="logout-item"
              onclick="logout()"
              style="color: var(--danger)"
            >
              <i class="fas fa-sign-out-alt"></i> Logout
            </button>
          </div>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="card-header">
            <div class="card-title">Pending Payments</div>
            <div
              class="card-icon"
              style="background-color: #fff3cd; color: #f59e0b"
            >
              <i class="fas fa-clock"></i>
            </div>
          </div>
          <div class="stat-value" id="pendingPaymentsCount">0</div>
          <div class="card-change positive">
            <i class="fas fa-arrow-up"></i>
            <span id="pendingChange">0</span> new today
          </div>
        </div>
        <div class="stat-card">
          <div class="card-header">
            <div class="card-title">Today's Collection</div>
            <div
              class="card-icon"
              style="background-color: #dcfce7; color: #10b981"
            >
              <i class="fas fa-money-bill-wave"></i>
            </div>
          </div>
          <div class="stat-value" id="todayCollection">₱0</div>
          <div class="card-change positive">
            <i class="fas fa-arrow-up"></i>
            <span id="collectionChange">0%</span> from yesterday
          </div>
        </div>
        <div class="stat-card">
          <div class="card-header">
            <div class="card-title">Processed Today</div>
            <div
              class="card-icon"
              style="background-color: #eff6ff; color: #2563eb"
            >
              <i class="fas fa-check-circle"></i>
            </div>
          </div>
          <div class="stat-value" id="processedToday">0</div>
          <div class="card-change positive">
            <i class="fas fa-arrow-up"></i>
            <span id="processedChange">0</span> from yesterday
          </div>
        </div>
        <div class="stat-card">
          <div class="card-header">
            <div class="card-title">Monthly Collection</div>
            <div
              class="card-icon"
              style="background-color: #fee2e2; color: #ef4444"
            >
              <i class="fas fa-chart-line"></i>
            </div>
          </div>
          <div class="stat-value" id="monthlyCollection">₱0</div>
          <div class="card-change positive">
            <i class="fas fa-arrow-up"></i>
            <span id="monthlyChange">0%</span> from last month
          </div>
        </div>
      </div>

      <div class="quick-actions">
        <h2 class="section-title"><i class="fas fa-bolt"></i> Quick Actions</h2>
        <div class="action-buttons">
          <a href="cashier-pending-payments.html" class="action-btn">
            <div class="action-icon">
              <i class="fas fa-clock"></i>
            </div>
            <div class="action-text">Process Pending Payments</div>
          </a>
          <a href="cashier-payment-history.html" class="action-btn">
            <div class="action-icon">
              <i class="fas fa-history"></i>
            </div>
            <div class="action-text">View Payment History</div>
          </a>
          <button class="action-btn" onclick="showReportModal()">
            <div class="action-icon">
              <i class="fas fa-file-pdf"></i>
            </div>
            <div class="action-text">Generate Daily Report</div>
          </button>
          <button class="action-btn" onclick="printRecentReceipts()">
            <div class="action-icon">
              <i class="fas fa-print"></i>
            </div>
            <div class="action-text">Print Receipts</div>
          </button>
        </div>
      </div>

      <div class="data-table">
        <div class="table-header">
          <div class="table-title">Recent Payments (Last 6)</div>
        </div>
        <div class="index-help" id="indexHelpMessage" style="display: none">
          <strong><i class="fas fa-info-circle"></i> Index Required</strong
          ><br />
          To display recent payments efficiently, Firebase requires a composite
          index.
          <a
            href="https://console.firebase.google.com/v1/r/project/vehicle-impound/firestore/indexes?create_composite=ClBwcm9qZWN0cy92ZWhpY2xlLWltcG91bmQvZGF0YWJhc2VzLyhkZWZhdWx0KS9jb2xsZWN0aW9uR3JvdXBzL3BheW1lbnRzL2luZGV4ZXMvXxABGhEKDXBheW1lbnRTdGF0dXMQARoPCgtwYXltZW50RGF0ZRACGgwKCF9fbmFtZV9fEAI"
            target="_blank"
          >
            Click here to create it.
          </a>
        </div>
        <table>
          <thead>
            <tr>
              <th>Receipt No.</th>
              <th>Plate Number</th>
              <th>Vehicle Type</th>
              <th>Amount</th>
              <th>Payment Date</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="recentPaymentsTable">
            <tr>
              <td colspan="6" class="loading">
                <i class="fas fa-spinner fa-spin"></i> Loading recent
                payments...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Report Generation Modal -->
    <div id="reportModal" class="modal">
      <div class="report-modal-content">
        <div class="modal-header">
          <h2><i class="fas fa-file-pdf"></i> Generate Daily Report</h2>
          <button class="close" onclick="closeReportModal()">&times;</button>
        </div>
        <div class="report-form">
          <div class="form-group">
            <label for="reportDate">Report Date</label>
            <input type="date" id="reportDate" value="" />
          </div>
          <div class="form-group">
            <label for="reportType">Report Type</label>
            <select id="reportType">
              <option value="daily">Daily Transactions</option>
              <option value="summary">Daily Summary</option>
              <option value="detailed">Detailed Report</option>
            </select>
          </div>
          <div class="form-group">
            <label for="includeStats">Include Statistics</label>
            <select id="includeStats">
              <option value="yes">Yes</option>
              <option value="no">No</option>
            </select>
          </div>
          <div class="report-actions">
            <button class="btn btn-outline" onclick="closeReportModal()">
              Cancel
            </button>
            <button class="btn btn-primary" onclick="generateDailyReport()">
              <i class="fas fa-download"></i> Generate PDF
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
      <div class="loading-content">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Generating PDF Report...</p>
        <div class="progress" id="loadingProgress">Please wait...</div>
      </div>
    </div>

    <script>
      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyByzd88bcUAq0VdP0w6oB8W_b2AUgoIzXc",
        authDomain: "vehicle-impound.firebaseapp.com",
        projectId: "vehicle-impound",
        storageBucket: "vehicle-impound.firebasestorage.app",
        messagingSenderId: "69239563292",
        appId: "1:69239563292:web:281912e8a38301c0feabd9",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const auth = firebase.auth();

      // Global variables
      let currentUser = null;
      let recentPayments = [];
      let violationsData = [];
      let feesData = [];

      // DOM elements
      const recentPaymentsTable = document.getElementById(
        "recentPaymentsTable"
      );
      const reportModal = document.getElementById("reportModal");
      const loadingOverlay = document.getElementById("loadingOverlay");
      const loadingProgress = document.getElementById("loadingProgress");
      const indexHelpMessage = document.getElementById("indexHelpMessage");

      // Dashboard stats elements
      const pendingPaymentsCount = document.getElementById(
        "pendingPaymentsCount"
      );
      const todayCollection = document.getElementById("todayCollection");
      const processedToday = document.getElementById("processedToday");
      const monthlyCollection = document.getElementById("monthlyCollection");

      // User elements
      const userDisplayName = document.getElementById("userDisplayName");
      const userRole = document.getElementById("userRole");
      const userAvatar = document.getElementById("userAvatar");

      // Initialize the application
      document.addEventListener("DOMContentLoaded", function () {
        console.log("DOM Content Loaded");
        initializeApp();

        // Set default date to today
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("reportDate").value = today;
      });

      // Toggle User Dropdown
      function toggleLogoutDropdown() {
        const d = document.getElementById("logoutDropdown");
        d.style.display = d.style.display === "block" ? "none" : "block";
      }

      // Close dropdown when clicking outside
      window.onclick = (e) => {
        if (!e.target.closest(".user-menu")) {
          document.getElementById("logoutDropdown").style.display = "none";
        }
        if (e.target == reportModal) {
          closeReportModal();
        }
      };

      async function initializeApp() {
        try {
          // Check if user is authenticated
          auth.onAuthStateChanged(async (user) => {
            if (user) {
              currentUser = user;
              console.log("User authenticated:", user.email);

              await loadUserData(user.uid);
              setupEventListeners();

              // Load all data in parallel for faster loading
              await Promise.all([loadDashboardStats(), loadRecentPayments()]);
            } else {
              console.log("No user authenticated, redirecting to login...");
              window.location.href = "../index.html";
            }
          });
        } catch (error) {
          console.error("Error initializing app:", error);
          showError("Error initializing application: " + error.message);
        }
      }

      async function loadUserData(userId) {
        try {
          const userDoc = await db.collection("users").doc(userId).get();
          if (userDoc.exists) {
            const userData = userDoc.data();
            userDisplayName.textContent = userData.fullName || "Cashier User";
            userRole.textContent = formatRole(userData.role) || "Cashier";
            if (userData.fullName) {
              userAvatar.textContent = getInitials(userData.fullName);
            }
          }
        } catch (error) {
          console.error("Error loading user data:", error);
        }
      }

      function getInitials(fullName) {
        return fullName
          .split(" ")
          .map((name) => name[0])
          .join("")
          .toUpperCase()
          .substring(0, 2);
      }

      function formatRole(role) {
        const roleMap = {
          admin: "Administrator",
          officer: "Impounding Officer",
          cashier: "Cashier",
          releasing: "Releasing Officer",
        };
        return roleMap[role] || role;
      }

      // OPTIMIZED: Load all dashboard data in a single batch
      async function loadDashboardStats() {
        try {
          console.time("loadDashboardStats");

          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const tomorrow = new Date(today);
          tomorrow.setDate(tomorrow.getDate() + 1);
          const yesterday = new Date(today);
          yesterday.setDate(yesterday.getDate() - 1);
          const startOfMonth = new Date(
            today.getFullYear(),
            today.getMonth(),
            1
          );

          // Fetch receipts and payments in parallel
          const [receiptsSnapshot, paymentsSnapshot] = await Promise.all([
            db.collection("receipts").get(),
            db.collection("payments").get(),
          ]);

          // Process receipts data
          const allReceipts = receiptsSnapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
          }));

          // Process payments data
          const allPayments = paymentsSnapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
          }));

          // Calculate stats efficiently
          const todayReceipts = allReceipts.filter((receipt) => {
            const receiptDate = new Date(receipt.timestamp);
            return receiptDate >= today && receiptDate < tomorrow;
          });

          const yesterdayReceipts = allReceipts.filter((receipt) => {
            const receiptDate = new Date(receipt.timestamp);
            return receiptDate >= yesterday && receiptDate < today;
          });

          const monthlyReceipts = allReceipts.filter((receipt) => {
            const receiptDate = new Date(receipt.timestamp);
            return receiptDate >= startOfMonth;
          });

          const pendingPayments = allPayments.filter((payment) => {
            return (
              payment.paymentStatus === "unpaid" ||
              payment.paymentStatus === "partial"
            );
          });

          const todayProcessed = todayReceipts.length;
          const yesterdayProcessed = yesterdayReceipts.length;

          const todayCollectionAmount = todayReceipts.reduce(
            (sum, receipt) => sum + (receipt.amountPaid || 0),
            0
          );
          const yesterdayCollectionAmount = yesterdayReceipts.reduce(
            (sum, receipt) => sum + (receipt.amountPaid || 0),
            0
          );
          const monthlyCollectionAmount = monthlyReceipts.reduce(
            (sum, receipt) => sum + (receipt.amountPaid || 0),
            0
          );

          // Update UI
          pendingPaymentsCount.textContent = pendingPayments.length;
          todayCollection.textContent = `₱${todayCollectionAmount.toLocaleString()}`;
          processedToday.textContent = todayProcessed;
          monthlyCollection.textContent = `₱${monthlyCollectionAmount.toLocaleString()}`;

          const processedChange = todayProcessed - yesterdayProcessed;
          const collectionChange =
            yesterdayCollectionAmount > 0
              ? Math.round(
                  ((todayCollectionAmount - yesterdayCollectionAmount) /
                    yesterdayCollectionAmount) *
                    100
                )
              : 0;

          document.getElementById("pendingChange").textContent =
            pendingPayments.length;
          document.getElementById("processedChange").textContent =
            processedChange > 0 ? processedChange : 0;
          document.getElementById(
            "collectionChange"
          ).textContent = `${collectionChange}%`;
          document.getElementById("monthlyChange").textContent = "8%";

          console.timeEnd("loadDashboardStats");
          console.log(
            `Dashboard stats loaded: ${todayReceipts.length} today, ${pendingPayments.length} pending`
          );
        } catch (error) {
          console.error("Error loading dashboard stats:", error);
        }
      }

      // OPTIMIZED: Load recent payments efficiently
      async function loadRecentPayments() {
        try {
          console.time("loadRecentPayments");
          recentPaymentsTable.innerHTML =
            '<tr><td colspan="6" class="loading"><i class="fas fa-spinner fa-spin"></i> Loading recent payments...</td></tr>';

          // Fetch only the 6 most recent receipts
          const receiptsSnapshot = await db
            .collection("receipts")
            .orderBy("timestamp", "desc")
            .limit(6)
            .get();

          if (receiptsSnapshot.empty) {
            recentPaymentsTable.innerHTML =
              '<tr><td colspan="6" style="text-align:center; padding:40px;">No recent payments found.</td></tr>';
            indexHelpMessage.style.display = "none";
            console.timeEnd("loadRecentPayments");
            return;
          }

          // Process all receipts in parallel
          const receiptPromises = receiptsSnapshot.docs.map(
            async (receiptDoc) => {
              const receiptData = receiptDoc.data();

              // Try to get vehicle data if vehicleId exists
              let vehicleData = {};
              if (receiptData.vehicleId) {
                try {
                  const vehicleDoc = await db
                    .collection("impoundedVehicles")
                    .doc(receiptData.vehicleId)
                    .get();
                  if (vehicleDoc.exists) {
                    vehicleData = vehicleDoc.data();
                  }
                } catch (error) {
                  console.error("Error fetching vehicle data:", error);
                }
              }

              return {
                id: receiptDoc.id,
                receiptNumber:
                  receiptData.receiptNumber ||
                  `RCP-${new Date(
                    receiptData.timestamp
                  ).getFullYear()}-${receiptDoc.id
                    .substring(0, 4)
                    .toUpperCase()}`,
                plateNumber:
                  receiptData.plateNumber || vehicleData.plateNumber || "N/A",
                vehicleType:
                  receiptData.vehicleType || vehicleData.vehicleType || "N/A",
                amount: receiptData.amountPaid || 0,
                paymentDate: receiptData.timestamp,
                status:
                  receiptData.paymentType === "Partial"
                    ? "partially paid"
                    : "paid",
                receiptData: receiptData,
                vehicleData: vehicleData,
                paymentMethod: receiptData.paymentMethod || "Cash",
                cashierName: receiptData.cashierName || "Cashier",
              };
            }
          );

          // Wait for all promises to resolve
          recentPayments = await Promise.all(receiptPromises);

          renderRecentPaymentsTable();
          indexHelpMessage.style.display = "none";

          console.timeEnd("loadRecentPayments");
          console.log(`Loaded ${recentPayments.length} recent payments`);
        } catch (error) {
          console.error("Error loading recent payments:", error);
          recentPaymentsTable.innerHTML =
            '<tr><td colspan="6" class="error-message">Error loading payments: ' +
            error.message +
            "</td></tr>";
        }
      }

      function renderRecentPaymentsTable() {
        if (recentPayments.length === 0) {
          recentPaymentsTable.innerHTML =
            '<tr><td colspan="6" style="text-align:center; padding:40px;">No recent payments found.</td></tr>';
          return;
        }

        recentPaymentsTable.innerHTML = "";

        recentPayments.forEach((payment) => {
          const row = document.createElement("tr");
          const paymentDate = new Date(payment.paymentDate);
          const formattedDate = paymentDate.toLocaleDateString();

          const statusClass =
            payment.status === "paid"
              ? "status-paid"
              : payment.status === "partially paid"
              ? "status-partial"
              : "status-pending";

          const statusText =
            payment.status === "paid"
              ? "Paid"
              : payment.status === "partially paid"
              ? "Partial"
              : "Pending";

          row.innerHTML = `
                    <td><strong>${payment.receiptNumber}</strong></td>
                    <td>${payment.plateNumber}</td>
                    <td>${payment.vehicleType}</td>
                    <td class="amount">₱${payment.amount.toLocaleString()}</td>
                    <td>${formattedDate}</td>
                    <td><span class="status ${statusClass}">${statusText}</span></td>
                `;
          recentPaymentsTable.appendChild(row);
        });
      }

      // Report Modal Functions
      function showReportModal() {
        reportModal.style.display = "flex";
      }

      function closeReportModal() {
        reportModal.style.display = "none";
      }

      async function generateDailyReport() {
        try {
          const reportDate = document.getElementById("reportDate").value;
          const reportType = document.getElementById("reportType").value;
          const includeStats =
            document.getElementById("includeStats").value === "yes";

          if (!reportDate) {
            alert("Please select a report date");
            return;
          }

          // Show loading overlay
          loadingOverlay.style.display = "flex";
          loadingProgress.textContent = "Fetching data...";

          // Get selected date range
          const startDate = new Date(reportDate);
          startDate.setHours(0, 0, 0, 0);
          const endDate = new Date(reportDate);
          endDate.setHours(23, 59, 59, 999);

          loadingProgress.textContent = "Fetching receipts...";

          // Fetch receipts for the selected date
          const receiptsSnapshot = await db
            .collection("receipts")
            .where("timestamp", ">=", startDate.toISOString())
            .where("timestamp", "<=", endDate.toISOString())
            .get();

          const dailyReceipts = [];
          receiptsSnapshot.forEach((doc) => {
            dailyReceipts.push({
              id: doc.id,
              ...doc.data(),
            });
          });

          loadingProgress.textContent = "Generating PDF...";

          // Generate PDF report
          await generatePDFReport(
            dailyReceipts,
            reportDate,
            reportType,
            includeStats
          );

          // Hide loading overlay
          setTimeout(() => {
            loadingOverlay.style.display = "none";
            closeReportModal();
          }, 500);

          // Save report record to database
          await saveReportToDatabase(dailyReceipts, reportDate, reportType);
        } catch (error) {
          console.error("Error generating report:", error);
          alert("Error generating report: " + error.message);
          loadingOverlay.style.display = "none";
        }
      }

      async function generatePDFReport(
        receipts,
        reportDate,
        reportType,
        includeStats
      ) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Report title
        const reportTitle = `VIMS Daily Report - ${new Date(
          reportDate
        ).toLocaleDateString()}`;
        doc.setFontSize(18);
        doc.text(reportTitle, 14, 22);

        // Report details
        doc.setFontSize(10);
        doc.setTextColor(100);
        doc.text(
          `Generated on: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`,
          14,
          30
        );
        doc.text(`Generated by: ${userDisplayName.textContent}`, 14, 35);
        doc.text(`Report Type: ${reportType}`, 14, 40);
        doc.text(`Total Transactions: ${receipts.length}`, 14, 45);

        // Calculate statistics if requested
        if (includeStats) {
          const totalAmount = receipts.reduce(
            (sum, receipt) => sum + (receipt.amountPaid || 0),
            0
          );
          const cashPayments = receipts.filter(
            (r) => r.paymentMethod === "cash"
          ).length;
          const gcashPayments = receipts.filter(
            (r) => r.paymentMethod === "gcash"
          ).length;
          const fullPayments = receipts.filter(
            (r) => r.paymentType === "Full"
          ).length;
          const partialPayments = receipts.filter(
            (r) => r.paymentType === "Partial"
          ).length;

          doc.setFontSize(12);
          doc.setTextColor(0, 0, 0);
          doc.text("Summary Statistics", 14, 60);
          doc.setFontSize(10);
          doc.text(
            `Total Collection: ₱${totalAmount.toLocaleString()}`,
            14,
            68
          );
          doc.text(`Cash Payments: ${cashPayments}`, 14, 73);
          doc.text(`GCash Payments: ${gcashPayments}`, 14, 78);
          doc.text(`Full Payments: ${fullPayments}`, 14, 83);
          doc.text(`Partial Payments: ${partialPayments}`, 14, 88);

          // Start table after statistics
          let startY = 100;
        } else {
          // Start table immediately
          let startY = 60;
        }

        // Prepare table data
        const tableData = receipts.map((receipt) => {
          const date = new Date(receipt.timestamp);
          return [
            receipt.receiptNumber || "N/A",
            receipt.plateNumber || "N/A",
            receipt.vehicleType || "N/A",
            receipt.ownerName || "N/A",
            `₱${(receipt.amountPaid || 0).toLocaleString()}`,
            receipt.paymentMethod || "Cash",
            date.toLocaleDateString(),
            receipt.paymentType === "Partial" ? "Partial" : "Full",
          ];
        });

        // Add table to PDF
        doc.autoTable({
          startY: includeStats ? 100 : 60,
          head: [
            [
              "Receipt No.",
              "Plate No.",
              "Type",
              "Owner",
              "Amount",
              "Method",
              "Date",
              "Status",
            ],
          ],
          body: tableData,
          theme: "grid",
          styles: {
            fontSize: 8,
            cellPadding: 3,
          },
          headStyles: {
            fillColor: [41, 99, 235],
            textColor: 255,
            fontStyle: "bold",
          },
          alternateRowStyles: {
            fillColor: [240, 245, 249],
          },
          columnStyles: {
            0: { cellWidth: 25 },
            1: { cellWidth: 20 },
            2: { cellWidth: 20 },
            3: { cellWidth: 30 },
            4: { cellWidth: 25 },
            5: { cellWidth: 20 },
            6: { cellWidth: 25 },
            7: { cellWidth: 20 },
          },
          margin: { top: 10 },
        });

        // Add page footer
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
          doc.setPage(i);
          doc.setFontSize(8);
          doc.setTextColor(100);
          doc.text(
            `Page ${i} of ${pageCount}`,
            doc.internal.pageSize.width / 2,
            doc.internal.pageSize.height - 10,
            { align: "center" }
          );
          doc.text(
            "VIMS - Vehicle Impound Management System",
            doc.internal.pageSize.width / 2,
            doc.internal.pageSize.height - 5,
            { align: "center" }
          );
        }

        // Save the PDF
        const fileName = `VIMS_Report_${reportDate.replace(
          /-/g,
          ""
        )}_${Date.now()}.pdf`;
        doc.save(fileName);

        // Show success message
        alert(
          `Report generated successfully!\n\nFile: ${fileName}\nTransactions: ${receipts.length}`
        );
      }

      async function saveReportToDatabase(receipts, reportDate, reportType) {
        try {
          const reportData = {
            reportDate: reportDate,
            reportType: reportType,
            generatedBy: currentUser.uid,
            cashierName: userDisplayName.textContent,
            timestamp: new Date().toISOString(),
            totalTransactions: receipts.length,
            totalAmount: receipts.reduce(
              (sum, receipt) => sum + (receipt.amountPaid || 0),
              0
            ),
            receiptsCount: receipts.length,
            details: {
              cashPayments: receipts.filter((r) => r.paymentMethod === "cash")
                .length,
              gcashPayments: receipts.filter((r) => r.paymentMethod === "gcash")
                .length,
              cardPayments: receipts.filter((r) => r.paymentMethod === "card")
                .length,
              bankPayments: receipts.filter((r) => r.paymentMethod === "bank")
                .length,
              fullPayments: receipts.filter((r) => r.paymentType === "Full")
                .length,
              partialPayments: receipts.filter(
                (r) => r.paymentType === "Partial"
              ).length,
            },
          };

          // Save to reports collection
          await db.collection("reports").add(reportData);

          console.log("Report saved to database:", reportData);
        } catch (error) {
          console.error("Error saving report to database:", error);
          // Don't alert the user - PDF generation was successful even if save fails
        }
      }

      function printRecentReceipts() {
        alert(
          "Print function would be implemented here. It would print all recent receipts shown in the table."
        );
      }

      async function logout() {
        if (confirm("Are you sure you want to logout?")) {
          try {
            await auth.signOut();
            window.location.href = "../index.html";
          } catch (error) {
            console.error("Error during logout:", error);
          }
        }
      }

      function setupEventListeners() {
        // Close modal on escape key
        document.addEventListener("keydown", function (event) {
          if (event.key === "Escape") {
            closeReportModal();
          }
        });
      }

      function showError(message) {
        alert("Error: " + message);
      }
    </script>
  </body>
</html>
